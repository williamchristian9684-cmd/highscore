<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>OSRS Clan Stats</title>
<style>
    body {
        font-family: Arial, sans-serif;
        background: #1b1b1b;
        color: #e6e6e6;
        margin: 0;
        padding: 20px;
    }
    h1 {
        text-align: center;
        margin-top: 10px;
        color: #ffd76b;
    }
    #progress {
        text-align: center;
        margin: 15px 0;
        font-size: 18px;
    }
    .container {
        max-width: 1200px;
        margin: auto;
    }
    table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 10px;
        font-size: 14px;
        background: #262626;
    }
    th, td {
        border: 1px solid #333;
        padding: 8px;
        text-align: center;
    }
    th {
        background: #333;
        position: sticky;
        top: 0;
        z-index: 2;
    }
    .error {
        color: #ff6b6b;
        font-weight: bold;
    }
    .success {
        color: #90ee90;
    }
    #retryBtn {
        display: block;
        margin: 15px auto;
        padding: 10px 20px;
        background: #444;
        color: #fff;
        border: none;
        cursor: pointer;
        font-size: 16px;
        border-radius: 5px;
    }
    #retryBtn:hover {
        background: #555;
    }
</style>
</head>
<body>

<h1>OSRS Clan Stats</h1>

<div id="progress">Loading…</div>

<button id="retryBtn" style="display:none;">Retry Failed Players</button>

<div class="container">
    <table id="statsTable"></table>
</div>

<script>
/* -----------------------------------------------------------
   CONFIG
----------------------------------------------------------- */

const SKILLS = [
  "overall","attack","defence","strength","hitpoints","ranged","prayer",
  "magic","cooking","woodcutting","fletching","fishing","firemaking",
  "crafting","smithing","mining","herblore","agility","thieving","slayer",
  "farming","runecraft","hunter","construction"
];

// --- ADD YOUR PLAYERS HERE ---
const PLAYERS = [
  { name: "Zezima", color: "#ffd700" },
  { name: "Lynx Titan", color: "#7fe7ff" },
  { name: "Settled", color: "#ffae7f" }
];

let playerStats = {};

/* -----------------------------------------------------------
   RELIABLE HISCORE FETCH SYSTEM
   - infinite retries
   - timeout
   - proxy rotation
   - validation
   - exponential backoff
----------------------------------------------------------- */

const PROXIES = [
  u => "https://api.allorigins.win/raw?url=" + encodeURIComponent(u),
  u => "https://cors.zimjs.com/?url=" + encodeURIComponent(u),
  u => "https://thingproxy.freeboard.io/fetch/" + u
];

async function fetchWithTimeout(url, timeout = 15000) {
  const controller = new AbortController();
  const id = setTimeout(() => controller.abort(), timeout);
  try {
    return await fetch(url, { signal: controller.signal });
  } finally {
    clearTimeout(id);
  }
}

async function fetchPlayer(playerName) {
  const hiscoreUrl =
    "https://secure.runescape.com/m=hiscore_oldschool/index_lite.ws?player=" +
    encodeURIComponent(playerName);

  let attempt = 0;

  while (true) {
    const proxy = PROXIES[attempt % PROXIES.length];
    const finalUrl = proxy(hiscoreUrl);

    try {
      console.log(`Fetching ${playerName} using proxy #${attempt % PROXIES.length + 1}`);

      const res = await fetchWithTimeout(finalUrl, 15000);
      if (!res.ok) throw new Error("HTTP " + res.status);

      const text = await res.text();

      // Validate format
      const lines = text.trim().split("\n");
      if (lines.length < 5 || !lines[0].includes(",")) {
        throw new Error("Invalid hiscore format");
      }

      // Parse stats
      const stats = {};
      for (let i = 0; i < SKILLS.length; i++) {
        const [rank, level, xp] = lines[i].split(",");
        stats[SKILLS[i]] = {
          rank: Number(rank),
          level: Number(level),
          xp: Number(xp)
        };
      }

      stats.combat = calculateCombat(stats);
      playerStats[playerName] = stats;
      return;

    } catch (err) {
      console.warn(`Attempt failed for ${playerName}:`, err);

      // Slow exponential backoff
      const delay = Math.min(500 * Math.pow(1.5, attempt), 8000);
      await new Promise(r => setTimeout(r, delay));

      attempt++;
    }
  }
}

/* -----------------------------------------------------------
   COMBAT CALCULATION
----------------------------------------------------------- */
function calculateCombat(s) {
  const def = s.defence.level;
  const hp = s.hitpoints.level;
  const pray = s.prayer.level;
  const atk = s.attack.level;
  const str = s.strength.level;
  const rng = s.ranged.level;
  const mag = s.magic.level;

  return Math.floor(
    0.25 * (def + hp + Math.floor(pray / 2)) +
    0.325 * Math.max(
      atk + str,
      Math.floor((rng * 1.5)),
      Math.floor((mag * 1.5))
    )
  );
}

/* -----------------------------------------------------------
   TABLE RENDERING
----------------------------------------------------------- */

function renderTable() {
  let html = `
    <tr>
      <th>Name</th>
      <th>Combat</th>
      <th>Overall</th>
      ${SKILLS.slice(1).map(s => `<th>${s}</th>`).join("")}
    </tr>
  `;

  for (const p of PLAYERS) {
    const s = playerStats[p.name];

    if (!s) {
      html += `
        <tr>
          <td style="color:${p.color}">${p.name}</td>
          <td colspan="${SKILLS.length}" class="error">Loading…</td>
        </tr>
      `;
      continue;
    }

    const error = s.error;

    if (error) {
      html += `
        <tr>
          <td style="color:${p.color}">${p.name}</td>
          <td colspan="${SKILLS.length}" class="error">Failed (Click Retry)</td>
        </tr>
      `;
      continue;
    }

    html += `
      <tr>
        <td style="color:${p.color}">${p.name}</td>
        <td>${s.combat}</td>
        <td>${s.overall.level}</td>
        ${SKILLS.slice(1).map(skill => `<td>${s[skill].level}</td>`).join("")}
      </tr>
    `;
  }

  document.getElementById("statsTable").innerHTML = html;
}

/* -----------------------------------------------------------
   LOADING CONTROL
----------------------------------------------------------- */

async function loadAllPlayers() {
  let loaded = 0;
  document.getElementById("retryBtn").style.display = "none";

  for (const p of PLAYERS) {
    await fetchPlayer(p.name);
    loaded++;
    document.getElementById("progress").innerText =
      `Loaded ${loaded} / ${PLAYERS.length} players...`;
    renderTable();
  }

  document.getElementById("progress").innerText = "All players loaded.";
}

document.getElementById("retryBtn").onclick = () => {
  const failed = PLAYERS.filter(p => playerStats[p.name]?.error);
  if (failed.length === 0) return;

  failed.forEach(p => delete playerStats[p.name]);
  loadAllPlayers();
};

loadAllPlayers();
</script>

</body>
</html>
