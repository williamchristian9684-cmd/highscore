<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Chivalry Legion High Scores</title>

<style>
html,body{height:100%;margin:0;padding:0;background:#000;color:#fff;font-family:Arial,sans-serif;}
body{padding:20px;box-sizing:border-box;}
.tabs { display:flex; justify-content:center; gap:5px; margin-bottom:15px; }
.tab-btn { padding:8px 15px; background:#111; border:none; color:#fff; cursor:pointer; border-radius:5px; }
.tab-btn.active { background:orange; color:#000; font-weight:bold; }
.container { display:flex; gap:15px; max-width:1600px; margin:0 auto; min-height:calc(100vh - 200px); }
.column { background:#111; border-radius:8px; padding:15px; border:1px solid #444; overflow-x:auto; }
.column h2 { text-align:center; color:orange; margin-bottom:10px; }
.stats-table { width:100%; border-collapse:collapse; }
.stats-table th, .stats-table td { border:1px solid #444; padding:8px; text-align:center; }
.stats-table th { background:#222; font-weight:bold; color:#fff; cursor:pointer; }
.stats-table td { background:#111; color:#eee; }
.stats-table tr:nth-child(even) td { background:#1a1a1a; }
.stats-table tbody tr:hover { background:#333 !important; }
.tooltip { display:none; position:fixed; background:#222; padding:10px; border-radius:6px; box-shadow:0 0 10px rgba(255,255,255,0.3); z-index:999; min-width:220px; max-height:400px; overflow-y:auto; color:#fff; font-size:12px; white-space:nowrap; }
.legend-box { width:180px; }
.legend-box div { font-weight:bold; margin:5px 0; cursor:pointer; }
.loading { text-align:center; font-style:italic; color:#999; }
.error { color:#ff4d4d; font-weight:bold; }
.refresh-btn { display:block; margin:10px auto 20px auto; padding:5px 10px; background:orange; color:#000; font-weight:bold; border:none; border-radius:5px; cursor:pointer; }
#lastUpdated { text-align:center; font-size:12px; color:#aaa; margin-top:10px; }
#searchBar { display:block; margin:0 auto 15px auto; padding:5px 10px; width:300px; border-radius:5px; border:none; }
</style>
</head>
<body>

<img id="clanLogo" src="https://i.imgur.com/OU2IAhu.png" alt="Clan Logo" style="display:block;margin:0 auto 10px auto; max-width:150px;cursor:pointer;">

<input type="text" id="searchBar" placeholder="Search by Name or Nickname">

<div class="tabs">
  <button class="tab-btn active" data-tab="mains">Mains</button>
  <button class="tab-btn" data-tab="meds">Meds and Pures</button>
  <button class="tab-btn" data-tab="ironman">Ironman</button>
  <button class="tab-btn" data-tab="hcim">HCIM</button>
  <button class="tab-btn" data-tab="uim">UIM</button>
</div>

<div class="container">
  <div class="column legend-box" id="ranksLegend">
    <h2>Ranks Legend</h2>
    <div style="color:#FF2900;" data-color="#FF2900">Leader</div>
    <div style="color:#FF00E1;" data-color="#FF00E1">Council</div>
    <div style="color:#00FF91;" data-color="#00FF91">Captain</div>
    <div style="color:#FFF12E;" data-color="#FFF12E">Legend</div>
    <div style="color:#ADA653;" data-color="#ADA653">Elder</div>
    <div style="color:#A30090;" data-color="#A30090">Old School</div>
    <div style="color:#0E00A3;" data-color="#0E00A3">Senior</div>
    <div style="color:#003CFF;" data-color="#003CFF">Member</div>
    <div style="color:#00BFFF;" data-color="#00BFFF">Trial</div>
    <div style="color:#B6B6B6;" data-color="#B6B6B6">Retired</div>
    <button class="refresh-btn" id="unfilterRankBtn">Unfilter</button>
  </div>

  <div class="column" style="flex:1;">
    <table class="stats-table" id="statsTable">
      <thead>
        <tr>
          <th data-sort="name">Name</th>
          <th data-sort="nickname">Nickname</th>
          <th data-sort="attack">Attack</th>
          <th data-sort="strength">Strength</th>
          <th data-sort="defence">Defence</th>
          <th data-sort="ranged">Ranged</th>
          <th data-sort="magic">Magic</th>
          <th data-sort="prayer">Prayer</th>
          <th data-sort="combat">Combat</th>
          <th data-sort="total">Total</th>
        </tr>
      </thead>
      <tbody id="statsTableBody"><tr><td colspan="10" class="loading">Loading...</td></tr></tbody>
    </table>
  </div>

  <div class="column" style="width:250px;">
    <h2>Average Stats</h2>
    <div id="averageContent">Loading...</div>
    <button class="refresh-btn" id="unfilterSkillBtn">Unfilter</button>
  </div>
</div>

<div id="lastUpdated"></div>
<div class="tooltip" id="tooltip"></div>

<script>
/* -------- Player Lists -------- */
const TABS = {
  mains: [
    { name:'G3ND3RB3ND3R',nickname:'Rare',color:'#FF2900' },
    { name:'Big Mac luvr',nickname:'Braden',color:'#FF2900' },
    { name:'Bonds',nickname:'Gage',color:'#FF2900' },
    { name:'Kanger0o',nickname:'Karate',color:'#FF2900' },
    { name:'777 Hit Man',nickname:'Uube',color:'#FF00E1' },
    { name:'ForeskinKim',nickname:'JPS',color:'#FF00E1' },
    { name:'AEST NFS',nickname:'Kaylpso',color:'#00FF91' },
    { name:'I take off',nickname:'Buff',color:'#00FF91' },
    { name:'b udsy',nickname:'Budsy',color:'#00FF91' },
    { name:'Roo Rider',nickname:'Joog',color:'#FFF12E' },
    { name:'Purewax',nickname:'Wax',color:'#ADA653' },
    { name:'Infidel',nickname:'Infidel',color:'#ADA653' },
    { name:'Cutyourgrass',nickname:'Cutty',color:'#A30090' },
    { name:'Volunteer',nickname:'Volunteer',color:'#A30090' },
    { name:'cwazi',nickname:'Stally',color:'#A30090' },
    { name:'JoshD',nickname:'JoshD',color:'#A30090' },
    { name:'Wut Da Hally' ,nickname:'Pizza',color:'#0E00A3' },
    { name:'NZ Apho' ,nickname:'Apho',color:'#003CFF' },
    { name:'Arty Knight' ,nickname:'Dawson',color:'#003CFF' },
    { name:'CHLEFY' ,nickname:'Chief',color:'#003CFF' }, 
    { name:'K21' ,nickname:'Chief',color:'#003CFF' }, 
    { name:'Kristalnacht' ,nickname:'Midas',color:'#003CFF' }
  ],

  meds: [
   { name:'YRUG',nickname:'Rare',color:'#FF2900' },
   { name:'TA-Q-BIN',nickname:'Volunteer',color:'#A30090' },
   { name:'Stiffysniffa' ,nickname:'Infidel',color:'#ADA653' },
   { name:'I screw off',nickname:'Buff',color:'#00FF91' },
   { name:'alehouse',nickname:'Stally',color:'#A30090' }
  ],

  ironman:[
    { name:'Iron Hayden',nickname:'Hayden',color:'#00FF91' },
    { name:'Big Shame' ,nickname:'Buff',color:'#00FF91' }
  ],
  hcim:[
    { name:'HCWarrior',nickname:'HCW',color:'#ADA653' }
  ],
  uim:[
    { name:'UltimateU',nickname:'UU',color:'#A30090' }
  ]
};

/* -------- Skills -------- */
const SKILLS = [
  'overall','attack','strength','defence','hitpoints','ranged','prayer','magic',
  'cooking','woodcutting','fletching','fishing','firemaking','crafting','smithing',
  'mining','herblore','agility','thieving','slayer','farming','runecraft','hunter',
  'construction','sailing'
];

const SKILL_ICONS = {
  attack:'âš”ï¸',strength:'ðŸ’ª',defence:'ðŸ›¡ï¸',ranged:'ðŸ¹',magic:'âœ¨',prayer:'ðŸ™',hitpoints:'â¤ï¸',
  cooking:'ðŸ³',woodcutting:'ðŸª“',fletching:'ðŸ¹',fishing:'ðŸŽ£',firemaking:'ðŸ”¥',crafting:'ðŸ§µ',
  smithing:'ðŸ”¨',mining:'â›ï¸',herblore:'ðŸŒ¿',agility:'ðŸƒ',thieving:'ðŸ—ï¸',slayer:'ðŸ‘¹',
  farming:'ðŸŒ¾',runecraft:'ðŸ“œ',hunter:'ðŸ¹',construction:'ðŸ ',sailing:'â›µ'
};

/* -------- Global State -------- */
let currentTab='mains';
let playerStats={};
let currentSort={skill:'total',order:'desc'};
let rankFilter=null;
let skillFilter=null;
let searchFilter='';

/* -------- Combat Formula -------- */
function calculateCombat(s){
  const a=s.attack?.level||1, b=s.strength?.level||1, d=s.defence?.level||1, hp=s.hitpoints?.level||10;
  const p=s.prayer?.level||1, r=s.ranged?.level||1, m=s.magic?.level||1;
  return Math.floor(0.25*(d+hp+Math.floor(p/2)) + 0.325*Math.max(a+b, Math.floor(r/2)+r, Math.floor(m/2)+m));
}

/* -------- Fallback CORS Proxies -------- */
const PROXIES = [
  url => "https://api.allorigins.win/raw?url=" + encodeURIComponent(url),
  url => "https://cors.zimjs.com/?url=" + encodeURIComponent(url),
  url => "https://thingproxy.freeboard.io/fetch/" + url
];

/* -------- Fetch Player With Proxy Rotation -------- */
async function fetchPlayer(playerName){
  const hiscoreUrl =
    "https://secure.runescape.com/m=hiscore_oldschool/index_lite.ws?player=" +
    encodeURIComponent(playerName);

  let lastError=null;

  for(let i=0;i<PROXIES.length;i++){
    const proxyUrl = PROXIES[i](hiscoreUrl);

    try{
      const res = await fetch(proxyUrl,{cache:"no-store"});
      if(!res.ok) throw new Error("HTTP "+res.status);
      const txt = await res.text();

      if(!txt.includes(",")) throw new Error("Invalid hiscore data");

      const lines = txt.trim().split("\n");
      const stats={};

      for(let j=0;j<lines.length && j<SKILLS.length;j++){
        const parts = lines[j].split(",");
        stats[SKILLS[j]] = {
          rank: Number(parts[0]),
          level: Number(parts[1]),
          xp: Number(parts[2])
        };
      }

      stats.combat = calculateCombat(stats);
      stats.overall = { level:Number(lines[0].split(",")[1]) };

      playerStats[playerName]=stats;
      return; // SUCCESS
    }
    catch(err){
      lastError=err;
      console.warn("Proxy "+(i+1)+" failed for "+playerName,err);
    }
  }

  // All proxies failed:
  playerStats[playerName] = { error:true };
}

/* -------- Load a Tab -------- */
async function loadTab(tab){
  currentTab=tab;
  playerStats={};
  document.getElementById('statsTableBody').innerHTML=`<tr><td colspan="10" class="loading">Loading...</td></tr>`;
  document.getElementById('averageContent').innerHTML='Loading...';
  
  const players=TABS[tab];
  await Promise.all(players.map(p=>fetchPlayer(p.name)));

  renderTable();
  renderAverageBox();
  document.getElementById('lastUpdated').textContent='Last updated: '+new Date().toLocaleString();
}

/* -------- Sorting -------- */
function sortPlayers(arr,key,order){
  return arr.slice().sort((a,b)=>{
    const sa=playerStats[a.name], sb=playerStats[b.name];
    if(!sa||sa.error) return 1;
    if(!sb||sb.error) return -1;
    if(key==='name'||key==='nickname')
      return order==='asc'? a[key].localeCompare(b[key]) : b[key].localeCompare(a[key]);

    const va=(key==='total'?sa.overall?.level:key==='combat'?sa.combat:sa[key]?.level)||0;
    const vb=(key==='total'?sb.overall?.level:key==='combat'?sb.combat:sb[key]?.level)||0;

    return order==='asc'? va-vb : vb-va;
  });
}

/* -------- Render Table -------- */
function renderTable(){
  const tbody=document.getElementById('statsTableBody');
  let players=TABS[currentTab];

  if(rankFilter) players=players.filter(p=>p.color===rankFilter);
  if(searchFilter) players=players.filter(p=>p.name.toLowerCase().includes(searchFilter)||p.nickname.toLowerCase().includes(searchFilter));

  if(skillFilter){
    players = players.map(p=>({...p, skillStat:playerStats[p.name][skillFilter]}))
                .filter(p=>p.skillStat)
                .sort((a,b)=>b.skillStat.xp-a.skillStat.xp);

    let html='';
    for(const p of players){
      const s=p.skillStat;
      html+=`
      <tr>
        <td style="color:${p.color}">${p.name}</td>
        <td>${p.nickname}</td>
        <td colspan="8">${s.level} (XP: ${s.xp})</td>
      </tr>`;
    }
    tbody.innerHTML=html;
    attachTooltip();
    return;
  }

  players=sortPlayers(players,currentSort.skill,currentSort.order);

  let html='';
  for(const p of players){
    const s=playerStats[p.name];

    if(!s || s.error){
      html+=`
      <tr>
        <td style="color:${p.color}">${p.name}</td>
        <td>${p.nickname}</td>
        <td colspan="8" class="error">Error loading stats</td>
      </tr>`;
      continue;
    }

    html+=`
    <tr>
      <td style="color:${p.color}">${p.name}</td>
      <td>${p.nickname}</td>
      <td>${s.attack?.level||0}</td>
      <td>${s.strength?.level||0}</td>
      <td>${s.defence?.level||0}</td>
      <td>${s.ranged?.level||0}</td>
      <td>${s.magic?.level||0}</td>
      <td>${s.prayer?.level||0}</td>
      <td>${s.combat||0}</td>
      <td>${s.overall?.level||0}</td>
    </tr>`;
  }

  tbody.innerHTML=html;
  attachTooltip();
}

/* -------- Averages Sidebar -------- */
function renderAverageBox(){
  const container=document.getElementById('averageContent');
  const players=TABS[currentTab];
  const total={};

  for(const skill of SKILLS.concat(['combat','total'])) total[skill]=0;

  let count=0;

  for(const p of players){
    const s=playerStats[p.name];
    if(!s || s.error) continue;
    count++;
    for(const skill of SKILLS) total[skill]+=s[skill]?.level||0;
    total.combat+=s.combat||0;
    total.total+=s.overall?.level||0;
  }

  let html='';
  for(const skill of SKILLS){
    const avg=count?Math.round(total[skill]/count):0;
    html+=`
      <div style="cursor:pointer;" onclick="skillFilter='${skill}';renderTable();">
        ${SKILL_ICONS[skill]||''} ${skill.charAt(0).toUpperCase()+skill.slice(1)}: ${avg}
      </div>`;
  }

  html+=`<div>Average Combat: ${count?Math.round(total.combat/count):0}</div>`;
  html+=`<div>Average Total: ${count?Math.round(total.total/count):0}</div>`;

  container.innerHTML=html;
}

/* -------- Tooltip -------- */
const tooltip=document.getElementById('tooltip');

function showTooltip(e,playerName,stats){
  let html=`<strong>${playerName}</strong><br>`;
  for(const s of SKILLS){
    html+=`${SKILL_ICONS[s]||''} ${s}: ${stats[s]?.level||0} (XP: ${stats[s]?.xp||0})<br>`;
  }
  html+=`Combat: ${stats.combat}<br>`;
  html+=`Total: ${stats.overall?.level}`;
  tooltip.innerHTML=html;
  tooltip.style.display='block';
  tooltip.style.top=`${e.clientY+10}px`;
  tooltip.style.left=`${e.clientX+10}px`;
}

function moveTooltip(e){
  tooltip.style.top=`${e.clientY+10}px`;
  tooltip.style.left=`${e.clientX+10}px`;
}

function hideTooltip(){ tooltip.style.display='none'; }

function attachTooltip(){
  document.querySelectorAll('#statsTable tbody tr').forEach(tr=>{
    tr.onmouseenter = e=>{
      const name=tr.children[0].textContent;
      if(playerStats[name] && !playerStats[name].error)
        showTooltip(e,name,playerStats[name]);
    };
    tr.onmousemove = moveTooltip;
    tr.onmouseleave = hideTooltip;
  });
}

/* -------- UI Events -------- */
document.querySelectorAll('.tab-btn').forEach(btn=>{
  btn.addEventListener('click',()=>{
    document.querySelectorAll('.tab-btn').forEach(b=>b.classList.remove('active'));
    btn.classList.add('active');
    loadTab(btn.dataset.tab);
  });
});

document.querySelectorAll('th').forEach(th=>{
  th.addEventListener('click',()=>{
    const key=th.dataset.sort;
    if(currentSort.skill===key)
      currentSort.order=currentSort.order==='asc'?'desc':'asc';
    else { currentSort.skill=key; currentSort.order='desc'; }
    renderTable();
  });
});

document.querySelectorAll('#ranksLegend div[data-color]').forEach(div=>{
  div.addEventListener('click',()=>{ rankFilter=div.dataset.color; renderTable(); });
});

document.getElementById('unfilterRankBtn').addEventListener('click',()=>{ rankFilter=null; renderTable(); });
document.getElementById('unfilterSkillBtn').addEventListener('click',()=>{ skillFilter=null; renderTable(); });

document.getElementById('searchBar').addEventListener('input',e=>{
  searchFilter=e.target.value.toLowerCase();
  renderTable();
});

document.getElementById('clanLogo').addEventListener('click',()=>loadTab(currentTab));

/* -------- Start Page -------- */
window.addEventListener('load',()=>loadTab('mains'));
</script>

</body>
</html>
