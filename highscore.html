<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Chivalry Legion High Scores</title>
<style>
body {
  font-family: Arial, sans-serif;
  background: #000;
  color: #fff;
  margin: 0;
  padding: 20px;
}

h1 {
  text-align:center;
  color: orange;
  margin-bottom: 20px;
}

.container {
  display: flex;
  gap: 20px;
  max-width: 1600px;
  margin: 0 auto;
}

/* Player Table */
.stats-table {
  width: 100%;
  border-collapse: collapse;
}
.stats-table th, .stats-table td {
  border: 1px solid #444;
  padding: 8px;
  text-align: center;
}
.stats-table th {
  background: #222;
  font-weight: bold;
  color: #fff;
}
.stats-table td {
  background: #111;
  color: #eee;
}
.stats-table tr:nth-child(even) td {
  background: #1a1a1a;
}
.stats-table tbody tr:hover {
  background: #333 !important;
}
.player-name {
  font-weight: bold;
  cursor:pointer;
}

/* Tooltip */
.tooltip {
  display: none;
  position: fixed;
  background: #222;
  padding: 10px;
  border-radius: 6px;
  box-shadow: 0 0 10px rgba(255,255,255,0.3);
  z-index: 999;
  min-width: 220px;
  max-height: 300px;
  overflow-y: auto;
  color: #fff;
  font-size: 12px;
  white-space: nowrap;
}

/* Sort icons */
.sort-icons {
  display: inline-block;
  margin-left: 5px;
  cursor: pointer;
  font-size: 12px;
  vertical-align: middle;
}
.sort-icons span {
  display: block;
  line-height: 10px;
}

/* Side boxes */
.side-box {
  width: 250px;
  background: #111;
  padding: 15px;
  border-radius: 8px;
  border: 1px solid #444;
  color: #fff;
  font-size: 14px;
}
.side-box h2 {
  text-align:center;
  color: orange;
  margin-bottom:10px;
}

/* Ranks Legend */
#ranksLegend div {
  font-weight: bold;
  margin-bottom:5px;
}
</style>
</head>
<body>

<h1>Chivalry Legion High Scores</h1>

<div class="container">
  <!-- Left: Ranks Legend -->
  <div class="side-box" id="ranksLegend">
    <h2>Ranks Legend</h2>
  </div>

  <!-- Center: Player Table -->
  <table class="stats-table" id="statsTable">
    <thead>
      <tr>
        <th>Player <span class="sort-icons" data-skill="name"><span>‚ñ≤</span><span>‚ñº</span></span></th>
        <th>‚öîÔ∏è Attack <span class="sort-icons" data-skill="attack"><span>‚ñ≤</span><span>‚ñº</span></span></th>
        <th>üí™ Strength <span class="sort-icons" data-skill="strength"><span>‚ñ≤</span><span>‚ñº</span></span></th>
        <th>üõ°Ô∏è Defence <span class="sort-icons" data-skill="defence"><span>‚ñ≤</span><span>‚ñº</span></span></th>
        <th>üèπ Ranged <span class="sort-icons" data-skill="ranged"><span>‚ñ≤</span><span>‚ñº</span></span></th>
        <th>‚ú® Magic <span class="sort-icons" data-skill="magic"><span>‚ñ≤</span><span>‚ñº</span></span></th>
        <th>üôè Prayer <span class="sort-icons" data-skill="prayer"><span>‚ñ≤</span><span>‚ñº</span></span></th>
        <th>‚ù§Ô∏è Hitpoints <span class="sort-icons" data-skill="hitpoints"><span>‚ñ≤</span><span>‚ñº</span></span></th>
        <th>‚öîÔ∏è Combat <span class="sort-icons" data-skill="combat"><span>‚ñ≤</span><span>‚ñº</span></span></th>
        <th>Total Level <span class="sort-icons" data-skill="total"><span>‚ñ≤</span><span>‚ñº</span></span></th>
      </tr>
    </thead>
    <tbody id="statsTableBody">
      <tr><td colspan="10" class="loading">Loading...</td></tr>
    </tbody>
  </table>

  <!-- Right: Average Stats -->
  <div class="side-box" id="averageBox">
    <h2>Average Stats</h2>
    <div id="averageContent">Loading...</div>
  </div>
</div>

<div class="tooltip" id="tooltip"></div>

<script>
const PLAYERS = [
  { name: 'G3ND3RB3ND3R', color: '#FF2900' },
  { name: 'Big Mac luvr', color: '#FF2900' },
  { name: '777 Hit Man', color: '#FF00E1' },
  { name: 'AEST NFS', color: '#00FF91' },
  { name: 'Thisthat', color: '#ADA653' },
  { name: 'JoshD', color: '#A30090' },
  { name: 'Cutyourgrass', color: '#A30090' },
];

const RANKS = [
  { name:'Leader', color:'#FF2900' },
  { name:'Council', color:'#FF00E1' },
  { name:'Captain', color:'#00FF91' },
  { name:'Legend', color:'#FFF12E' },
  { name:'Elder', color:'#ADA653' },
  { name:'Old School', color:'#A30090' },
  { name:'Senior', color:'#0E00A3' },
  { name:'Member', color:'#003CFF' },
  { name:'Trial', color:'#00BFFF' },
  { name:'Retired', color:'#B6B6B6' },
];

const SKILLS = [
  'overall','attack','defence','strength','hitpoints','ranged','prayer','magic','cooking','woodcutting',
  'fletching','fishing','firemaking','crafting','smithing','mining','herblore','agility','thieving','slayer',
  'farming','runecraft','hunter','construction','sailing'
];

let playerStats = {};
let currentSort = { skill:'total', order:'desc' };

// Skill icons
const SKILL_ICONS = {
  attack:'‚öîÔ∏è', strength:'üí™', defence:'üõ°Ô∏è', ranged:'üèπ',
  magic:'‚ú®', prayer:'üôè', hitpoints:'‚ù§Ô∏è', combat:'‚öîÔ∏è',
  cooking:'üç≥', woodcutting:'ü™ì', fletching:'üèπ', fishing:'üé£',
  firemaking:'üî•', crafting:'üßµ', smithing:'üî®', mining:'‚õèÔ∏è',
  herblore:'üåø', agility:'üèÉ', thieving:'üóùÔ∏è', slayer:'üëπ',
  farming:'üåæ', runecraft:'üìú', hunter:'üèπ', construction:'üè†',
  sailing:'‚õµ'
};

// Initialize Ranks Legend
const ranksDiv = document.getElementById('ranksLegend');
RANKS.forEach(r => {
  const d = document.createElement('div');
  d.style.color = r.color;
  d.textContent = r.name;
  ranksDiv.appendChild(d);
});

function calculateCombat(stats) {
  const a = stats.attack?.level||1;
  const s = stats.strength?.level||1;
  const d = stats.defence?.level||1;
  const hp = stats.hitpoints?.level||10;
  const p = stats.prayer?.level||1;
  const r = stats.ranged?.level||1;
  const m = stats.magic?.level||1;
  const base = 0.25*(d+hp+Math.floor(p/2));
  const melee = 0.325*(a+s);
  const range = 0.325*(Math.floor(r/2)+r);
  const mage = 0.325*(Math.floor(m/2)+m);
  return Math.floor(base+Math.max(melee,range,mage));
}

async function fetchPlayer(playerName){
  const urls = [
    'https://api.allorigins.win/raw?url=' + encodeURIComponent('https://secure.runescape.com/m=hiscore_oldschool/index_lite.ws?player=' + playerName),
    'https://api.codetabs.com/v1/proxy?quest=' + encodeURIComponent('https://secure.runescape.com/m=hiscore_oldschool/index_lite.ws?player=' + playerName)
  ];
  for(const url of urls){
    try{
      const res = await fetch(url);
      if(!res.ok) throw new Error('HTTP '+res.status);
      const txt = await res.text();
      const lines = txt.trim().split('\n');
      const stats = {};
      for(let i=0;i<lines.length && i<SKILLS.length;i++){
        const parts = lines[i].split(',');
        if(parts.length!==3) continue;
        stats[SKILLS[i]]={ rank:parseInt(parts[0],10), level:parseInt(parts[1],10), xp:parseInt(parts[2],10) };
      }
      stats.combat = calculateCombat(stats);
      playerStats[playerName] = stats;
      return;
    }catch(err){ console.warn('Failed fetch for '+playerName+' with '+url); }
  }
  playerStats[playerName]={error:true};
}

async function loadAllPlayers(){
  playerStats={};
  await Promise.all(PLAYERS.map(p=>fetchPlayer(p.name)));
  renderTable();
  renderAverageBox();
}

function sortPlayers(arr, key, order){
  return arr.slice().sort((a,b)=>{
    const sa=playerStats[a.name], sb=playerStats[b.name];
    if(!sa||sa.error) return 1;
    if(!sb||sb.error) return -1;
    if(key==='name') return order==='asc'? a.name.localeCompare(b.name) : b.name.localeCompare(a.name);
    let va,vb;
    if(key==='total') { va=sa.overall?.level||0; vb=sb.overall?.level||0; }
    else if(key==='combat') { va=sa.combat||0; vb=sb.combat||0; }
    else { va=sa[key]?.level||0; vb=sb[key]?.level||0; }
    return order==='asc'? va-vb : vb-va;
  });
}

function renderTable(){
  const tbody=document.getElementById('statsTableBody');
  const sorted = sortPlayers(PLAYERS, currentSort.skill, currentSort.order);
  let html='';
  for(const p of sorted){
    const s = playerStats[p.name];
    if(!s){ html+=`<tr><td colspan="10" class="loading">Loading ${p.name}‚Ä¶</td></tr>`; continue; }
    if(s.error){ html+=`<tr><td class="player-name" style="color:${p.color}">${p.name}</td><td colspan="9" class="error">Name not found</td></tr>`; continue; }
    const cells = [
      s.attack?.level, s.strength?.level, s.defence?.level,
      s.ranged?.level, s.magic?.level, s.prayer?.level,
      s.hitpoints?.level, s.combat, s.overall?.level
    ];
    html+=`<tr>
      <td class="player-name" style="color:${p.color}">${p.name}</td>
      ${cells.map(c=>`<td>${c!==undefined?c:'-'}</td>`).join('')}
    </tr>`;
  }
  tbody.innerHTML = html;
  attachTooltip();
}

const tooltip=document.getElementById('tooltip');

function showTooltip(e, playerName, stats){
  let html = `<strong>${playerName}</strong><br>`;
  if(stats.error){ html+='Name not found'; }
  else{
    for(const skill of Object.keys(stats)){
      if(skill==='overall' || skill==='combat') continue;
      html += `${SKILL_ICONS[skill]||''} ${skill.charAt(0).toUpperCase()+skill.slice(1)}: ${stats[skill].level}<br>`;
    }
    html += `‚öîÔ∏è Combat: ${stats.combat}<br>Total Level: ${stats.overall?.level||0}<br>`;
  }
  tooltip.innerHTML=html;
  tooltip.style.display='block';
  tooltip.style.top=`${e.clientY+10}px`;
  tooltip.style.left=`${e.clientX+10}px`;
}

function moveTooltip(e){ tooltip.style.top=`${e.clientY+10}px`; tooltip.style.left=`${e.clientX+10}px`; }
function hideTooltip(){ tooltip.style.display='none'; }

function attachTooltip(){
  document.querySelectorAll('td.player-name').forEach(td=>{
    td.addEventListener('mouseenter', e=>{
      const playerName=td.textContent;
      const stats=playerStats[playerName];
      showTooltip(e,playerName,stats);
    });
    td.addEventListener('mousemove', moveTooltip);
    td.addEventListener('mouseleave', hideTooltip);
  });
}

document.querySelectorAll('.sort-icons').forEach(icon=>{
  const skill = icon.dataset.skill;
  const spans = icon.querySelectorAll('span');
  spans[0].addEventListener('click', ()=>{
    currentSort = { skill, order:'asc' };
    renderTable();
    renderAverageBox();
  });
  spans[1].addEventListener('click', ()=>{
    currentSort = { skill, order:'desc' };
    renderTable();
    renderAverageBox();
  });
});

function renderAverageBox(){
  const container=document.getElementById('averageContent');
  const members = PLAYERS.length;
  let combatSum=0, totalSum=0;
  let skillSums = {};
  SKILLS.forEach(s=>{ if(s!=='overall') skillSums[s]=0; });
  let counted=0;

  for(const p of PLAYERS){
    const s=playerStats[p.name];
    if(!s||s.error) continue;
    counted++;
    combatSum += s.combat||0;
    totalSum += s.overall?.level||0;
    for(const skill of Object.keys(skillSums)){
      if(skill==='combat') continue;
      skillSums[skill] += s[skill]?.level||0;
    }
  }

  let html = `Number of members: ${members}<br>Average Combat: ${counted? Math.round(combatSum/counted):0}<br>Average Total Level: ${counted? Math.round(totalSum/counted):0}<br>`;
  for(const skill of Object.keys(skillSums)){
    html += `${SKILL_ICONS[skill]||''} ${skill.charAt(0).toUpperCase()+skill.slice(1)}: ${counted? Math.round(skillSums[skill]/counted):0}<br>`;
  }
  container.innerHTML = html;
}

window.addEventListener('load', loadAllPlayers);
</script>

</body>
</html>
