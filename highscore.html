<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Chivalry Legion High Scores</title>
<style>
body {
  font-family: Arial, sans-serif;
  background: #000;
  padding: 20px;
  color: #fff;
  display: flex;
  justify-content: center;
}
.container {
  max-width: 1200px;
  background: #111;
  padding: 20px;
  border-radius: 8px;
  box-shadow: 0 2px 8px rgba(255,255,255,0.05);
  display: flex;
}
.main-table {
  flex: 3;
}
h1 {
  text-align: center;
  color: orange;
}
.stats-table {
  width: 100%;
  border-collapse: collapse;
  margin-top: 10px;
}
.stats-table th, .stats-table td {
  border: 1px solid #444;
  padding: 8px;
  text-align: center;
}
.stats-table th {
  background: #222;
  color: #fff;
  font-weight: bold;
}
.stats-table td {
  background: #1a1a1a;
  color: #eee;
  position: relative;
}
.stats-table tr:nth-child(even) td {
  background: #2a2a2a;
}
td.player-name {
  font-weight: bold;
  cursor: pointer;
}
td.player-name:hover {
  color: #FFD700;
}
/* tooltip */
.tooltip {
  display: none;
  position: absolute;
  top: 0;
  left: 100%;
  background: #222;
  padding: 10px;
  border-radius: 6px;
  box-shadow: 0 0 10px rgba(255,255,255,0.3);
  z-index: 999;
  min-width: 200px;
  color: #fff;
  font-size: 12px;
}
.tooltip img {
  width: 16px;
  height: 16px;
  vertical-align: middle;
  margin-right: 4px;
}
/* Average stats box */
.stats-summary {
  flex: 1;
  margin-left: 20px;
  background: #111;
  padding: 10px;
  border-radius: 8px;
}
.stats-summary h2 {
  color: orange;
  text-align: center;
  font-size: 18px;
}
.loading { text-align:center; font-style:italic; color:#999; }
.error { color:#ff4d4d; font-weight:bold; }
.sort-icons {
  display: inline-block;
  margin-left: 5px;
  cursor: pointer;
  font-size: 12px;
  vertical-align: middle;
}
.sort-icons span {
  display: block;
  line-height: 10px;
}
</style>
</head>
<body>
<div class="container">
  <div class="main-table">
    <h1>Chivalry Legion High Scores</h1>
    <table class="stats-table" id="statsTable">
      <thead>
        <tr>
          <th>Player <span class="sort-icons" data-skill="name"><span>‚ñ≤</span><span>‚ñº</span></span></th>
          <th>‚öîÔ∏è Attack <span class="sort-icons" data-skill="attack"><span>‚ñ≤</span><span>‚ñº</span></span></th>
          <th>üí™ Strength <span class="sort-icons" data-skill="strength"><span>‚ñ≤</span><span>‚ñº</span></span></th>
          <th>üõ°Ô∏è Defence <span class="sort-icons" data-skill="defence"><span>‚ñ≤</span><span>‚ñº</span></span></th>
          <th>üèπ Ranged <span class="sort-icons" data-skill="ranged"><span>‚ñ≤</span><span>‚ñº</span></span></th>
          <th>‚ú® Magic <span class="sort-icons" data-skill="magic"><span>‚ñ≤</span><span>‚ñº</span></span></th>
          <th>üôè Prayer <span class="sort-icons" data-skill="prayer"><span>‚ñ≤</span><span>‚ñº</span></span></th>
          <th>‚ù§Ô∏è Hitpoints <span class="sort-icons" data-skill="hitpoints"><span>‚ñ≤</span><span>‚ñº</span></span></th>
          <th>‚öîÔ∏è Combat <span class="sort-icons" data-skill="combat"><span>‚ñ≤</span><span>‚ñº</span></span></th>
          <th>Total Level <span class="sort-icons" data-skill="total"><span>‚ñ≤</span><span>‚ñº</span></span></th>
        </tr>
      </thead>
      <tbody id="statsTableBody">
        <tr><td colspan="10" class="loading">Loading...</td></tr>
      </tbody>
    </table>
  </div>
  <div class="stats-summary" id="statsSummary">
    <h2>Average Stats</h2>
    <p id="numberMembers">Number of members: 0</p>
    <p id="avgAttack">Attack: 0</p>
    <p id="avgStrength">Strength: 0</p>
    <p id="avgDefence">Defence: 0</p>
    <p id="avgRanged">Ranged: 0</p>
    <p id="avgMagic">Magic: 0</p>
    <p id="avgPrayer">Prayer: 0</p>
    <p id="avgHitpoints">Hitpoints: 0</p>
    <p id="avgCombat">Combat: 0</p>
    <p id="avgTotal">Total Level: 0</p>
  </div>
</div>

<script>
const PLAYERS = [
  { name: 'G3ND3RB3ND3R', color: '#FF2900' },
  { name: '777 Hit Man', color: '#FF00E1' },
  { name: 'Big Mac luvr', color: '#FFAA00' },
];

const SKILLS = ['overall','attack','defence','strength','hitpoints','ranged','prayer','magic','cooking','woodcutting','fletching','fishing','firemaking','crafting','smithing','mining','herblore','agility','thieving','slayer','farming','runecraft','hunter','construction'];

let playerStats = {};
let currentSort = { skill:'total', order:'desc' };

function calculateCombat(stats){
  const a=stats.attack?.level||1;
  const s=stats.strength?.level||1;
  const d=stats.defence?.level||1;
  const hp=stats.hitpoints?.level||10;
  const p=stats.prayer?.level||1;
  const r=stats.ranged?.level||1;
  const m=stats.magic?.level||1;
  const base=0.25*(d+hp+Math.floor(p/2));
  const melee=0.325*(a+s);
  const range=0.325*(Math.floor(r/2)+r);
  const mage=0.325*(Math.floor(m/2)+m);
  return Math.floor(base+Math.max(melee,range,mage));
}

async function fetchPlayer(playerName){
  const urls=[
    'https://api.allorigins.win/raw?url=' + encodeURIComponent('https://secure.runescape.com/m=hiscore_oldschool/index_lite.ws?player=' + playerName),
    // add other fallback URLs if available
  ];
  let stats = null;
  for(const url of urls){
    try{
      const res=await fetch(url);
      if(!res.ok) throw new Error('HTTP '+res.status);
      const txt=await res.text();
      const lines=txt.trim().split('\n');
      stats={};
      for(let i=0;i<lines.length && i<SKILLS.length;i++){
        const parts=lines[i].split(',');
        if(parts.length!==3) continue;
        stats[SKILLS[i]]={rank:parseInt(parts[0],10),level:parseInt(parts[1],10),xp:parseInt(parts[2],10)};
      }
      stats.combat=calculateCombat(stats);
      playerStats[playerName]=stats;
      return;
    }catch(err){
      continue;
    }
  }
  playerStats[playerName]={error:true,errorMessage:'Name not found'};
}

async function loadAllPlayers(){
  playerStats={};
  await Promise.all(PLAYERS.map(p=>fetchPlayer(p.name)));
  renderTable();
  updateSummary();
}

function sortPlayers(arr,sortKey,order){
  return arr.slice().sort((a,b)=>{
    const sa=playerStats[a.name];
    const sb=playerStats[b.name];
    if(!sa||sa.error) return 1;
    if(!sb||sb.error) return -1;
    let va,vb;
    if(sortKey==='total'){va=sa.overall?.level||0;vb=sb.overall?.level||0;}
    else if(sortKey==='combat'){va=sa.combat||0;vb=sb.combat||0;}
    else if(sortKey==='name'){return order==='asc'?a.name.localeCompare(b.name):b.name.localeCompare(a.name);}
    else{va=sa[sortKey]?.level||0;vb=sb[sortKey]?.level||0;}
    return order==='asc'? va-vb: vb-va;
  });
}

function renderTable(){
  const tbody=document.getElementById('statsTableBody');
  const sortedPlayers=sortPlayers(PLAYERS,currentSort.skill,currentSort.order);
  let html='';
  for(const p of sortedPlayers){
    const s=playerStats[p.name];
    if(!s){
      html+=`<tr><td colspan="10" class="loading">Loading ${p.name}‚Ä¶</td></tr>`;
      continue;
    }
    if(s.error){
      html+=`<tr><td class="player-name" style="color:${p.color}">${p.name}</td><td colspan="9" class="error">${s.errorMessage}</td></tr>`;
      continue;
    }
    const cells=[s.attack?.level,s.strength?.level,s.defence?.level,s.ranged?.level,s.magic?.level,s.prayer?.level,s.hitpoints?.level,s.combat,s.overall?.level];
    html+=`<tr>
      <td class="player-name" style="color:${p.color}">${p.name}
        <div class="tooltip">
          ${SKILLS.slice(0,9).map(skill=>{
            const val=s[skill]?.level||'-';
            return `${skill.charAt(0).toUpperCase()+skill.slice(1)}: ${val}<br>`;
          }).join('')}
        </div>
      </td>
      ${cells.map(c=>`<td>${c!==undefined?c:'-'}</td>`).join('')}
    </tr>`;
  }
  tbody.innerHTML=html;
  addTooltipEvents();
}

function updateSummary(){
  const members=PLAYERS.length;
  document.getElementById('numberMembers').innerText=`Number of members: ${members}`;
  const sums={attack:0,strength:0,defence:0,ranged:0,magic:0,prayer:0,hitpoints:0,combat:0,total:0};
  let count=0;
  PLAYERS.forEach(p=>{
    const s=playerStats[p.name];
    if(s&&!s.error){
      count++;
      sums.attack+=s.attack?.level||0;
      sums.strength+=s.strength?.level||0;
      sums.defence+=s.defence?.level||0;
      sums.ranged+=s.ranged?.level||0;
      sums.magic+=s.magic?.level||0;
      sums.prayer+=s.prayer?.level||0;
      sums.hitpoints+=s.hitpoints?.level||0;
      sums.combat+=s.combat||0;
      sums.total+=s.overall?.level||0;
    }
  });
  document.getElementById('avgAttack').innerText=`Attack: ${Math.round(sums.attack/count)||0}`;
  document.getElementById('avgStrength').innerText=`Strength: ${Math.round(sums.strength/count)||0}`;
  document.getElementById('avgDefence').innerText=`Defence: ${Math.round(sums.defence/count)||0}`;
  document.getElementById('avgRanged').innerText=`Ranged: ${Math.round(sums.ranged/count)||0}`;
  document.getElementById('avgMagic').innerText=`Magic: ${Math.round(sums.magic/count)||0}`;
  document.getElementById('avgPrayer').innerText=`Prayer: ${Math.round(sums.prayer/count)||0}`;
  document.getElementById('avgHitpoints').innerText=`Hitpoints: ${Math.round(sums.hitpoints/count)||0}`;
  document.getElementById('avgCombat').innerText=`Combat: ${Math.round(sums.combat/count)||0}`;
  document.getElementById('avgTotal').innerText=`Total Level: ${Math.round(sums.total/count)||0}`;
}

// sort icon click
document.querySelectorAll('.sort-icons').forEach(icon=>{
  const skill=icon.dataset.skill;
  const spans=icon.querySelectorAll('span');
  spans[0].addEventListener('click',()=>{currentSort={skill,order:'asc'};renderTable();updateSummary();});
  spans[1].addEventListener('click',()=>{currentSort={skill,order:'desc'};renderTable();updateSummary();});
});

function addTooltipEvents(){
  document.querySelectorAll('.player-name').forEach(td=>{
    const tooltip=td.querySelector('.tooltip');
    td.addEventListener('mouseenter',()=>{
      tooltip.style.display='block';
      const rect=tooltip.getBoundingClientRect();
      const tdRect=td.getBoundingClientRect();
      if(rect.right>window.innerWidth){tooltip.style.left='auto';tooltip.style.right='100%';} else{tooltip.style.left='100%';tooltip.style.right='auto';}
      if(rect.bottom>window.innerHeight){tooltip.style.top=`${window.innerHeight-rect.height-tdRect.top-10}px`;} else{tooltip.style.top='0px';}
    });
    td.addEventListener('mouseleave',()=>{tooltip.style.display='none';tooltip.style.left='100%';tooltip.style.right='auto';tooltip.style.top='0px';});
  });
}

window.addEventListener('load',loadAllPlayers);
</script>
</body>
</html>
