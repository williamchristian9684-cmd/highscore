<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Chivalry Legion High Scores</title>

<style>
body {
  font-family: Arial, sans-serif;
  background: #000;
  color: #fff;
  margin:0;
  padding:20px;
}

h1 {
  text-align:center;
  color: orange;
  margin-bottom: 20px;
}

/* Layout */
.container {
  display: flex;
  gap: 20px;
  max-width: 1650px;
  margin: 0 auto;
}

.column {
  background: #111;
  border-radius: 8px;
  padding: 15px;
  border: 1px solid #444;
  overflow-x:auto;
}

.column h2 {
  text-align:center;
  color: orange;
  margin-bottom: 10px;
}

.stats-table {
  width: 100%;
  border-collapse: collapse;
}

.stats-table th, .stats-table td {
  border: 1px solid #444;
  padding: 8px;
  text-align: center;
}

.stats-table th {
  background: #222;
  font-weight: bold;
  color: #fff;
}

.stats-table td {
  background: #111;
  color: #eee;
}

.stats-table tr:nth-child(even) td {
  background: #1a1a1a;
}

.stats-table tbody tr:hover {
  background: #333 !important;
}

.player-name {
  font-weight: bold;
  cursor:pointer;
}

/* Tooltip */
.tooltip {
  display: none;
  position: fixed;
  background: #222;
  padding: 10px;
  border-radius: 6px;
  box-shadow: 0 0 10px rgba(255,255,255,0.3);
  z-index: 999;
  min-width: 220px;
  max-height: 400px;
  overflow-y: auto;
  color: #fff;
  font-size: 12px;
  white-space: nowrap;
}

/* Sorting icons */
.sort-icons {
  display: inline-block;
  margin-left: 5px;
  cursor: pointer;
  font-size: 12px;
  vertical-align: middle;
}
.sort-icons span {
  display: block;
  line-height: 10px;
}

/* Legend */
.legend-box div {
  font-weight: bold;
  margin: 6px 0;
}

/* Buttons */
.refresh-btn,
.clear-filter-btn,
.clear-skill-btn {
  display:block;
  margin: 10px auto 10px auto;
  padding: 6px 12px;
  background: red;
  color: #fff;
  font-weight: bold;
  border:none;
  border-radius:5px;
  cursor:pointer;
}

.refresh-btn {
  background: orange;
  color:black;
}

.loading { text-align:center; font-style:italic; color:#999; }
.error { color:#ff4d4d; font-weight:bold; }

/* Clan Logo */
.clan-logo {
  display:block;
  margin:0 auto 20px auto;
  width: 140px;
}
</style>
</head>
<body>

<img src="https://i.imgur.com/OU2IAhu.png" class="clan-logo">

<h1>Chivalry Legion High Scores</h1>
<button class="refresh-btn" onclick="loadAllPlayers()">Refresh</button>

<div id="lastUpdated" style="text-align:center; margin-bottom:10px; color:#aaa;"></div>

<div class="container">

  <!-- LEFT COLUMN: RANK LEGEND -->
  <div class="column" style="width:200px;">
    <h2>Ranks Legend</h2>
    <div data-rank="Leader" style="color:#FF2900;">Leader</div>
    <div data-rank="Council" style="color:#FF00E1;">Council</div>
    <div data-rank="Captain" style="color:#00FF91;">Captain</div>
    <div data-rank="Legend" style="color:#FFF12E;">Legend</div>
    <div data-rank="Elder" style="color:#ADA653;">Elder</div>
    <div data-rank="Old School" style="color:#A30090;">Old School</div>
    <div data-rank="Senior" style="color:#0E00A3;">Senior</div>
    <div data-rank="Member" style="color:#003CFF;">Member</div>
    <div data-rank="Trial" style="color:#00BFFF;">Trial</div>
    <div data-rank="Retired" style="color:#B6B6B6;">Retired</div>

    <button id="clearRankFilter" class="clear-filter-btn" style="display:none;">
      Clear Rank Filter
    </button>
  </div>

  <!-- MIDDLE COLUMN: PLAYER TABLE -->
  <div class="column" style="flex:1;">
    <table class="stats-table" id="statsTable">
      <thead>
        <tr>
          <th>Player <span class="sort-icons" data-skill="name"><span>â–²</span><span>â–¼</span></span></th>
          <th>âš”ï¸ Attack <span class="sort-icons" data-skill="attack"><span>â–²</span><span>â–¼</span></span></th>
          <th>ğŸ’ª Strength <span class="sort-icons" data-skill="strength"><span>â–²</span><span>â–¼</span></span></th>
          <th>ğŸ›¡ï¸ Defence <span class="sort-icons" data-skill="defence"><span>â–²</span><span>â–¼</span></span></th>
          <th>ğŸ¹ Ranged <span class="sort-icons" data-skill="ranged"><span>â–²</span><span>â–¼</span></span></th>
          <th>âœ¨ Magic <span class="sort-icons" data-skill="magic"><span>â–²</span><span>â–¼</span></span></th>
          <th>ğŸ™ Prayer <span class="sort-icons" data-skill="prayer"><span>â–²</span><span>â–¼</span></span></th>
          <th>â¤ï¸ Hitpoints <span class="sort-icons" data-skill="hitpoints"><span>â–²</span><span>â–¼</span></span></th>
          <th>âš”ï¸ Combat <span class="sort-icons" data-skill="combat"><span>â–²</span><span>â–¼</span></span></th>
          <th>Total <span class="sort-icons" data-skill="total"><span>â–²</span><span>â–¼</span></span></th>
        </tr>
      </thead>
      <tbody id="statsTableBody">
        <tr><td colspan="10" class="loading">Loading...</td></tr>
      </tbody>
    </table>
  </div>

  <!-- RIGHT COLUMN: AVERAGE OR SKILL LEADERBOARD -->
  <div class="column" style="width:280px;">
    <h2 id="rightTitle">Average Stats</h2>
    <div id="rightContent">Loading...</div>
    <button id="clearSkillFilter" class="clear-skill-btn" style="display:none;">Clear Skill Filter</button>
  </div>

</div>

<div class="tooltip" id="tooltip"></div>

<script>
/* ============= PLAYER LIST (WITH OPTIONAL NICKNAMES) ============= */

const PLAYERS = [
  { name: 'G3ND3RB3ND3R', nickname:'', color:'#FF2900', rank:'Leader' },
  { name: 'Big Mac luvr', nickname:'', color:'#FF2900', rank:'Leader' },
  { name: '777 Hit Man', nickname:'', color:'#FF00E1', rank:'Council' },
  { name: 'AEST NFS', nickname:'', color:'#00FF91', rank:'Captain' },
  { name: 'Big Shame', nickname:'', color:'#FFF12E', rank:'Legend' },
  { name: 'Purewax', nickname:'', color:'#ADA653', rank:'Elder' },
  { name: 'JoshD', nickname:'', color:'#A30090', rank:'Old School' },
  { name: 'Cutyourgrass', nickname:'', color:'#A30090', rank:'Old School' }
];

/* ============= SKILLS ============= */

const SKILLS = [
  'overall','attack','defence','strength','hitpoints',
  'ranged','prayer','magic','cooking','woodcutting',
  'fletching','fishing','firemaking','crafting','smithing',
  'mining','herblore','agility','thieving','slayer',
  'farming','runecraft','hunter','construction','sailing'
];

let playerStats = {};
let currentSort = { skill:'total', order:'desc' };
let activeRankFilter = null;
let activeSkillFilter = null;

/* ============= ICONS ============= */

const SKILL_ICONS = {
  attack:'âš”ï¸', strength:'ğŸ’ª', defence:'ğŸ›¡ï¸', ranged:'ğŸ¹',
  magic:'âœ¨', prayer:'ğŸ™', hitpoints:'â¤ï¸', combat:'âš”ï¸',
  cooking:'ğŸ³', woodcutting:'ğŸª“', fletching:'ğŸ¹', fishing:'ğŸ£',
  firemaking:'ğŸ”¥', crafting:'ğŸ§µ', smithing:'ğŸ”¨', mining:'â›ï¸',
  herblore:'ğŸŒ¿', agility:'ğŸƒ', thieving:'ğŸ—ï¸', slayer:'ğŸ‘¹',
  farming:'ğŸŒ¾', runecraft:'ğŸ“œ', hunter:'ğŸ¹', construction:'ğŸ ',
  sailing:'â›µ'
};

function calculateCombat(stats){
  const a=stats.attack?.level||1;
  const s=stats.strength?.level||1;
  const d=stats.defence?.level||1;
  const hp=stats.hitpoints?.level||10;
  const p=stats.prayer?.level||1;
  const r=stats.ranged?.level||1;
  const m=stats.magic?.level||1;
  const base=0.25*(d+hp+Math.floor(p/2));
  const melee=0.325*(a+s);
  const range=0.325*(Math.floor(r/2)+r);
  const mage=0.325*(Math.floor(m/2)+m);
  return Math.floor(base+Math.max(melee,range,mage));
}

/* ============= FETCHING (WITH RETRIES) ============= */
async function fetchPlayer(playerName){
  const urls=[
    'https://api.allorigins.win/raw?url=' + encodeURIComponent('https://secure.runescape.com/m=hiscore_oldschool/index_lite.ws?player='+playerName),
    'https://api.codetabs.com/v1/proxy?quest=' + encodeURIComponent('https://secure.runescape.com/m=hiscore_oldschool/index_lite.ws?player='+playerName)
  ];

  for(const url of urls){
    for(let attempt=0; attempt<3; attempt++){
      try{
        const res=await fetch(url);
        if(!res.ok) throw new Error("HTTP "+res.status);
        const txt=await res.text();
        const lines=txt.trim().split('\n');
        const s={};
        for(let i=0;i<lines.length && i<SKILLS.length;i++){
          const p=lines[i].split(',');
          if(p.length!==3) continue;
          s[SKILLS[i]]={
            rank:parseInt(p[0],10),
            level:parseInt(p[1],10),
            xp:parseInt(p[2],10)
          };
        }
        s.combat=calculateCombat(s);
        playerStats[playerName]=s;
        return;
      }catch(err){
        await new Promise(r=>setTimeout(r,300));
      }
    }
  }
  playerStats[playerName]={error:true};
}

async function loadAllPlayers(){
  playerStats={};
  document.getElementById('statsTableBody').innerHTML = `<tr><td colspan="10" class="loading">Loading...</td></tr>`;
  document.getElementById('rightContent').innerHTML='Loading...';

  await Promise.all(PLAYERS.map(p=>fetchPlayer(p.name)));

  renderTable();
  renderAverageBox();

  document.getElementById("lastUpdated").textContent =
    "Last updated: " + new Date().toLocaleString();
}

/* ============= RENDER TABLE ============= */
function renderTable(){
  const tbody=document.getElementById('statsTableBody');
  let list=PLAYERS;

  if(activeRankFilter)
    list=list.filter(p=>p.rank===activeRankFilter);

  list=sortPlayers(list, currentSort.skill, currentSort.order);

  let html='';
  for(const p of list){
    const s=playerStats[p.name];
    if(!s){ html+=`<tr><td colspan="10" class="loading">Loading ${p.name}â€¦</td></tr>`; continue; }
    if(s.error){ html+=`<tr><td class="player-name" style="color:${p.color}">${p.name}</td><td colspan="9" class="error">Name not found</td></tr>`; continue; }

    const cells=[
      s.attack?.level, s.strength?.level, s.defence?.level,
      s.ranged?.level, s.magic?.level, s.prayer?.level,
      s.hitpoints?.level, s.combat, s.overall?.level
    ];

    html+=`<tr>
      <td class="player-name" style="color:${p.color}">${p.name}${p.nickname ? " ("+p.nickname+")":""}</td>
      ${cells.map(c=>`<td>${c!==undefined?c:'-'}</td>`).join('')}
    </tr>`;
  }
  tbody.innerHTML=html;

  attachTooltip();
}

/* ============= SORTING ============= */
function sortPlayers(list,key,order){
  return list.slice().sort((a,b)=>{
    const sa=playerStats[a.name], sb=playerStats[b.name];
    if(!sa||sa.error) return 1;
    if(!sb||sb.error) return -1;

    if(key==='name'){
      return order==='asc'
        ? a.name.localeCompare(b.name)
        : b.name.localeCompare(a.name);
    }
    let va,vb;
    if(key==='total'){ va=sa.overall?.level||0; vb=sb.overall?.level||0; }
    else if(key==='combat'){ va=sa.combat||0; vb=sb.combat||0; }
    else{ va=sa[key]?.level||0; vb=sb[key]?.level||0; }
    return order==='asc'? va-vb : vb-va;
  });
}

document.querySelectorAll('.sort-icons').forEach(icon=>{
  const skill=icon.dataset.skill;
  const spans=icon.querySelectorAll('span');

  spans[0].addEventListener('click',()=>{
    currentSort={skill,order:'asc'};
    renderTable();
  });

  spans[1].addEventListener('click',()=>{
    currentSort={skill,order:'desc'};
    renderTable();
  });
});

/* ============= TOOLTIP ============= */
const tooltip=document.getElementById('tooltip');

function showTooltip(e,name,stats){
  let html='<strong>'+name+'</strong><br>';
  if(stats.error){ html+='Name not found'; }
  else{
    for(const skill of Object.keys(stats)){
      if(skill==='overall' || skill==='combat') continue;
      html+=`${SKILL_ICONS[skill]||''} ${skill}: ${stats[skill].level}<br>`;
    }
    html+=`âš”ï¸ Combat: ${stats.combat}<br>`;
    html+=`Total Level: ${stats.overall?.level||0}`;
  }
  tooltip.innerHTML=html;
  tooltip.style.display='block';
  tooltip.style.top=e.clientY+10+'px';
  tooltip.style.left=e.clientX+10+'px';
}
function moveTooltip(e){ tooltip.style.top=e.clientY+10+'px'; tooltip.style.left=e.clientX+10+'px'; }
function hideTooltip(){ tooltip.style.display='none'; }

function attachTooltip(){
  document.querySelectorAll('td.player-name').forEach(td=>{
    td.addEventListener('mouseenter',e=>{
      const name=td.textContent.replace(/\s*\(.+\)$/,'');
      showTooltip(e,name,playerStats[name]);
    });
    td.addEventListener('mousemove',moveTooltip);
    td.addEventListener('mouseleave',hideTooltip);
  });
}

/* ============= RANK FILTERING ============= */

document.querySelectorAll("[data-rank]").forEach(div=>{
  div.addEventListener("click",()=>{
    activeRankFilter = div.dataset.rank;
    document.getElementById("clearRankFilter").style.display = "block";
    renderTable();
  });
});

document.getElementById("clearRankFilter").addEventListener("click",()=>{
  activeRankFilter = null;
  document.getElementById("clearRankFilter").style.display = "none";
  renderTable();
});

/* ============= AVERAGE STATS OR SKILL LEADERBOARD ============= */

function renderAverageBox(){
  if(activeSkillFilter){
    renderSkillLeaderboard();
    return;
  }

  const box=document.getElementById("rightContent");
  const title=document.getElementById("rightTitle");
  title.textContent="Average Stats";

  let list=PLAYERS;
  if(activeRankFilter)
    list=list.filter(p=>p.rank===activeRankFilter);

  box.innerHTML='';
  const counted=list.filter(p=>!playerStats[p.name].error).length;

  let totalCombat=0, totalOverall=0;

  for(const p of list){
    const s=playerStats[p.name];
    if(!s || s.error) continue;
    totalCombat+=s.combat;
    totalOverall+=s.overall?.level||0;
  }

  box.innerHTML += `<strong>Number of players:</strong> ${list.length}<br>`;
  box.innerHTML += `<strong>Avg Combat:</strong> ${counted?Math.round(totalCombat/counted):0}<br>`;
  box.innerHTML += `<strong>Avg Total Level:</strong> ${counted?Math.round(totalOverall/counted):0}<br><br>`;

  box.innerHTML += `<h3 style="color:orange;text-align:center;">Skills</h3>`;

  SKILLS.forEach(skill=>{
    box.innerHTML += `<div style="cursor:pointer;color:#ccc;margin:4px 0;" onclick="filterBySkill('${skill}')">
      ${SKILL_ICONS[skill]||''} ${skill.charAt(0).toUpperCase()+skill.slice(1)}
    </div>`;
  });

  document.getElementById("clearSkillFilter").style.display="none";
}

/* ============= SKILL FILTER MODE ============= */

function filterBySkill(skill){
  activeSkillFilter = skill;
  renderSkillLeaderboard();
}

function renderSkillLeaderboard(){
  const title=document.getElementById("rightTitle");
  const box=document.getElementById("rightContent");
  const skill=activeSkillFilter;

  title.textContent = `Top ${skill.charAt(0).toUpperCase()+skill.slice(1)}`;

  let list=PLAYERS.filter(p=>!playerStats[p.name].error);

  if(activeRankFilter)
    list=list.filter(p=>p.rank===activeRankFilter);

  list=list.sort((a,b)=>{
    const sa=playerStats[a.name][skill]?.xp||0;
    const sb=playerStats[b.name][skill]?.xp||0;
    return sb - sa;
  });

  let html='';

  list.forEach(p=>{
    const s=playerStats[p.name][skill];
    if(!s) return;
    html+=`
      <div style="margin-bottom:6px;">
        <strong style="color:${p.color}">${p.name}</strong>
        ${p.nickname ? " ("+p.nickname+")" : ""}
        <br>
        Level: ${s.level} â€” XP: ${s.xp.toLocaleString()}
      </div>
      <hr style="border-color:#333;">
    `;
  });

  box.innerHTML=html;

  document.getElementById("clearSkillFilter").style.display="block";
}

document.getElementById("clearSkillFilter").addEventListener("click",()=>{
  activeSkillFilter=null;
  renderAverageBox();
});

/* ============= INIT ============= */
window.addEventListener('load', loadAllPlayers);

</script>
</body>
</html>
