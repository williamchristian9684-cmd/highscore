<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Chivalry Legion High Scores</title>
<style>
body {
  font-family: Arial, sans-serif;
  background: #000;
  padding: 20px;
  color: #fff;
  margin:0;
}
.container {
  max-width: 1200px;
  margin: 0 auto;
  background: #111;
  padding: 20px;
  border-radius: 8px;
  box-shadow: 0 2px 8px rgba(255,255,255,0.05);
}
h1 {
  text-align: center;
  color: orange;
  margin-bottom: 20px;
}
.stats-table {
  width: 100%;
  border-collapse: collapse;
  margin-top: 10px;
}
.stats-table th, .stats-table td {
  border: 1px solid #444;
  padding: 8px;
  text-align: center;
}
.stats-table th {
  background: #222;
  color: #fff;
  font-weight: bold;
  position: relative;
}
.stats-table td {
  background: #1a1a1a;
  color: #eee;
  position: relative;
}
.stats-table tr:nth-child(even) td {
  background: #2a2a2a;
}
td.player-name {
  font-weight: bold;
  cursor: pointer;
}
.sort-icons {
  display: inline-block;
  margin-left: 5px;
  cursor: pointer;
  font-size: 12px;
  vertical-align: middle;
}
.sort-icons span {
  display: block;
  line-height: 10px;
}
th img.skill-icon {
  width: 20px;
  height: 20px;
  vertical-align: middle;
  margin-right: 4px;
}
.loading { text-align:center; font-style:italic; color:#999; }
.error { color:#ff4d4d; font-weight:bold; }

/* Tooltip styling */
.tooltip {
  display:none;
  position:absolute;
  top:100%;
  left:50%;
  transform:translateX(-50%);
  background:#222;
  padding:10px;
  border-radius:6px;
  box-shadow:0 0 8px rgba(255,255,255,0.3);
  z-index:100;
  color:#fff;
  white-space: nowrap;
  max-width:400px;
}
.tooltip img {
  width:18px;
  height:18px;
  vertical-align:middle;
  margin-right:4px;
}
</style>
</head>
<body>
<div class="container">
<h1>Chivalry Legion High Scores</h1>

<table class="stats-table" id="statsTable">
  <thead>
    <tr>
      <th>Player 
        <span class="sort-icons" data-skill="name">
          <span title="A→Z">▲</span>
          <span title="Z→A">▼</span>
        </span>
      </th>
      <th><img src="https://oldschool.runescape.wiki/images/Attack_icon.png" class="skill-icon" alt="Attack">Attack <span class="sort-icons" data-skill="attack"><span>▲</span><span>▼</span></span></th>
      <th><img src="https://oldschool.runescape.wiki/images/Strength_icon.png" class="skill-icon" alt="Strength">Strength <span class="sort-icons" data-skill="strength"><span>▲</span><span>▼</span></span></th>
      <th><img src="https://oldschool.runescape.wiki/images/Defence_icon.png" class="skill-icon" alt="Defence">Defence <span class="sort-icons" data-skill="defence"><span>▲</span><span>▼</span></span></th>
      <th><img src="https://oldschool.runescape.wiki/images/Ranged_icon.png" class="skill-icon" alt="Ranged">Ranged <span class="sort-icons" data-skill="ranged"><span>▲</span><span>▼</span></span></th>
      <th><img src="https://oldschool.runescape.wiki/images/Magic_icon.png" class="skill-icon" alt="Magic">Magic <span class="sort-icons" data-skill="magic"><span>▲</span><span>▼</span></span></th>
      <th><img src="https://oldschool.runescape.wiki/images/Prayer_icon.png" class="skill-icon" alt="Prayer">Prayer <span class="sort-icons" data-skill="prayer"><span>▲</span><span>▼</span></span></th>
      <th><img src="https://i.imgur.com/F5OtqKX.png" class="skill-icon" alt="Hitpoints">Hitpoints <span class="sort-icons" data-skill="hitpoints"><span>▲</span><span>▼</span></span></th>
      <th><img src="https://oldschool.runescape.wiki/images/Combat_icon.png" class="skill-icon" alt="Combat">Combat <span class="sort-icons" data-skill="combat"><span>▲</span><span>▼</span></span></th>
      <th><img src="https://i.imgur.com/5IJv4Vq.png" class="skill-icon" alt="Total Level">Total Level <span class="sort-icons" data-skill="total"><span>▲</span><span>▼</span></span></th>
    </tr>
  </thead>
  <tbody id="statsTableBody">
    <tr><td colspan="10" class="loading">Loading...</td></tr>
  </tbody>
</table>
</div>

<script>
const PLAYERS = [
  { name: 'G3ND3RB3ND3R', color: '#FF2900' },
  { name: '777 Hit Man', color: '#FF00E1' },
  { name: 'Big Mac luvr', color: '#FF2900' },
];

const SKILLS = [
  'overall','attack','defence','strength','hitpoints',
  'ranged','prayer','magic','cooking','woodcutting',
  'fletching','fishing','firemaking','crafting','smithing',
  'mining','herblore','agility','thieving','slayer',
  'farming','runecraft','hunter','construction'
];

const ICONS = {
  attack:'https://oldschool.runescape.wiki/images/Attack_icon.png',
  strength:'https://oldschool.runescape.wiki/images/Strength_icon.png',
  defence:'https://oldschool.runescape.wiki/images/Defence_icon.png',
  hitpoints:'https://i.imgur.com/F5OtqKX.png',
  ranged:'https://oldschool.runescape.wiki/images/Ranged_icon.png',
  prayer:'https://oldschool.runescape.wiki/images/Prayer_icon.png',
  magic:'https://oldschool.runescape.wiki/images/Magic_icon.png',
  combat:'https://oldschool.runescape.wiki/images/Combat_icon.png',
  total:'https://i.imgur.com/5IJv4Vq.png'
};

let playerStats = {};
let currentSort = { skill:'total', order:'desc' };

function calculateCombat(stats) {
  const a = stats.attack?.level || 1;
  const s = stats.strength?.level || 1;
  const d = stats.defence?.level || 1;
  const hp = stats.hitpoints?.level || 10;
  const p = stats.prayer?.level || 1;
  const r = stats.ranged?.level || 1;
  const m = stats.magic?.level || 1;
  const base = 0.25 * (d + hp + Math.floor(p/2));
  const melee = 0.325 * (a + s);
  const range = 0.325 * (Math.floor(r/2) + r);
  const mage = 0.325 * (Math.floor(m/2) + m);
  return Math.floor(base + Math.max(melee, range, mage));
}

async function fetchPlayer(playerName){
  const proxyUrl = 'https://api.allorigins.win/raw?url=' +
    encodeURIComponent('https://secure.runescape.com/m=hiscore_oldschool/index_lite.ws?player=' + playerName);

  try{
    const res = await fetch(proxyUrl);
    if(!res.ok) throw new Error('HTTP status '+res.status);
    const txt = await res.text();
    const lines = txt.trim().split('\n');
    const stats = {};
    for(let i=0;i<lines.length && i<SKILLS.length;i++){
      const parts = lines[i].split(',');
      if(parts.length!==3) continue;
      stats[SKILLS[i]] = {
        rank: parseInt(parts[0],10),
        level: parseInt(parts[1],10),
        xp: parseInt(parts[2],10)
      };
    }
    stats.combat = calculateCombat(stats);
    playerStats[playerName] = stats;
  } catch(err){
    console.error('Error fetching '+playerName, err);
    playerStats[playerName] = { error:true, errorMessage: 'Name not found' };
  }
}

async function loadAllPlayers(){
  playerStats = {};
  const promises = PLAYERS.map(p=>fetchPlayer(p.name));
  await Promise.all(promises);
  renderTable();
}

function sortPlayers(arr, skill, order){
  return arr.slice().sort((a,b)=>{
    const sa = playerStats[a.name];
    const sb = playerStats[b.name];

    if(!sa||sa.error) return 1;
    if(!sb||sb.error) return -1;

    if(skill==='name'){
      const va=a.name.toLowerCase();
      const vb=b.name.toLowerCase();
      if(va<vb) return order==='asc'? -1:1;
      if(va>vb) return order==='asc'? 1:-1;
      return 0;
    }

    let va,vb;
    if(skill==='total'){ va=sa.overall?.level||0; vb=sb.overall?.level||0; }
    else if(skill==='combat'){ va=sa.combat||0; vb=sb.combat||0; }
    else{ va=sa[skill]?.level||0; vb=sb[skill]?.level||0; }

    return order==='asc'? va-vb : vb-va;
  });
}

function renderTable(){
  const tbody=document.getElementById('statsTableBody');
  const sortedPlayers = sortPlayers(PLAYERS, currentSort.skill, currentSort.order);
  let html='';
  for(const p of sortedPlayers){
    const s = playerStats[p.name];
    if(!s){
      html += `<tr><td colspan="10" class="loading">Loading ${p.name}…</td></tr>`;
      continue;
    }
    if(s.error){
      html += `<tr><td class="player-name" style="color:${p.color}" data-player="${p.name}">${p.name}</td><td colspan="9" class="error">${s.errorMessage}</td></tr>`;
      continue;
    }

    const cells = [
      s.attack?.level, s.strength?.level, s.defence?.level,
      s.ranged?.level, s.magic?.level, s.prayer?.level,
      s.hitpoints?.level, s.combat, s.overall?.level
    ];

    html += `<tr>
      <td class="player-name" style="color:${p.color}" data-player="${p.name}">${p.name}<div class="tooltip"></div></td>
      ${cells.map(c=>`<td>${c!==undefined?c:'-'}</td>`).join('')}
    </tr>`;
  }
  tbody.innerHTML=html;
  attachTooltips();
}

// Attach hover tooltips
function attachTooltips(){
  document.querySelectorAll('.player-name').forEach(td=>{
    td.addEventListener('mouseenter', e=>{
      const name = td.dataset.player;
      const stats = playerStats[name];
      const tooltip = td.querySelector('.tooltip');
      if(!stats||stats.error){
        tooltip.innerHTML = stats?.errorMessage || 'Name not found';
      } else {
        let html = '';
        const skillOrder = ['attack','strength','defence','ranged','magic','prayer','hitpoints','combat','total'];
        skillOrder.forEach(skill=>{
          const value = skill==='total'? stats.overall?.level : skill==='combat'? stats.combat : stats[skill]?.level;
          html += `<img src="${ICONS[skill]}" alt="${skill}">${skill.charAt(0).toUpperCase()+skill.slice(1)}: ${value}<br>`;
        });
        tooltip.innerHTML = html;
      }
      tooltip.style.display='block';
      // Adjust tooltip to stay on screen
      const rect = tooltip.getBoundingClientRect();
      const overflowX = rect.right - window.innerWidth;
      if(overflowX>0) tooltip.style.left = `calc(50% - ${overflowX}px)`;
    });
    td.addEventListener('mouseleave', e=>{
      td.querySelector('.tooltip').style.display='none';
      td.querySelector('.tooltip').style.left = '50%';
    });
  });
}

// Sort icon events
document.querySelectorAll('.sort-icons').forEach(icon=>{
  const skill = icon.dataset.skill;
  const spans = icon.querySelectorAll('span');
  spans[0].addEventListener('click',()=>{ currentSort={skill,order:'asc'}; renderTable(); });
  spans[1].addEventListener('click',()=>{ currentSort={skill,order:'desc'}; renderTable(); });
});

window.addEventListener('load', loadAllPlayers);
</script>
</body>
</html>
