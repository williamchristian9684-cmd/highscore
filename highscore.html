<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Chivalry Legion High Scores</title>

<style>
body {
  font-family: Arial, sans-serif;
  background: #000;
  color: #fff;
  margin:0;
  padding:20px;
}

/* ===================== HEADER + LOGO ====================== */
.logo {
  display:block;
  margin: 0 auto 10px auto;
  width: 160px;
}

h1 {
  text-align:center;
  color: orange;
  margin-top: 0;
  margin-bottom: 5px;
  font-size: 32px;
}

/* Timestamp */
#lastUpdated {
  text-align:center;
  margin-bottom: 15px;
  color: #ccc;
  font-size: 14px;
}

/* ===================== LAYOUT ====================== */
.container {
  display: flex;
  gap: 20px;
  max-width: 1600px;
  margin: 0 auto;
}

.column {
  background: #111;
  border-radius: 8px;
  padding: 15px;
  border: 1px solid #444;
  overflow-x:auto;
}

.column h2 {
  text-align:center;
  color: orange;
  margin-bottom: 10px;
}

/* ===================== TABLE ====================== */
.stats-table {
  width: 100%;
  border-collapse: collapse;
}

.stats-table th, .stats-table td {
  border: 1px solid #444;
  padding: 8px;
  text-align: center;
}

.stats-table th {
  background: #222;
  font-weight: bold;
  color: #fff;
  cursor: pointer;
}

.stats-table td {
  background: #111;
  color: #eee;
}

.stats-table tr:nth-child(even) td {
  background: #1a1a1a;
}

.stats-table tbody tr:hover {
  background: #333 !important;
}

.player-name, .nickname {
  font-weight: bold;
  cursor: pointer;
}

/* ===================== SORT ICONS ====================== */
.sort-icons {
  font-size: 12px;
  margin-left: 4px;
  opacity: 0.7;
}
.sort-icons span {
  display:block;
  line-height:8px;
}

/* ===================== TOOLTIP ====================== */
.tooltip {
  display: none;
  position: fixed;
  background: #222;
  padding: 10px;
  border-radius: 6px;
  box-shadow: 0 0 10px rgba(255,255,255,0.3);
  z-index: 999;
  min-width: 220px;
  max-height: 400px;
  overflow-y: auto;
  color: #fff;
  font-size: 12px;
  white-space: nowrap;
}

/* ===================== LEGEND ====================== */
.legend-box div {
  font-weight: bold;
  margin: 5px 0;
  cursor:pointer;
}
.legend-box div:hover {
  opacity: 0.6;
}

/* ===================== BUTTONS ====================== */
.refresh-btn, .clear-filter-btn {
  display:block;
  margin: 10px auto;
  padding: 5px 10px;
  background: orange;
  color: #000;
  font-weight: bold;
  border:none;
  border-radius:5px;
  cursor:pointer;
  text-align:center;
}

.clear-filter-btn {
  background:#ff4444;
  display:none;
}
</style>
</head>
<body>

<!-- Clan Logo -->
<img class="logo" src="https://i.imgur.com/OU2IAhu.png" alt="Clan Logo">

<h1>Chivalry Legion High Scores</h1>

<div id="lastUpdated">Last updated: Loading‚Ä¶</div>

<button class="refresh-btn" onclick="loadAllPlayers()">Refresh</button>
<button class="clear-filter-btn" id="clearFilterBtn" onclick="clearRankFilter()">Clear Rank Filter</button>


<div class="container">

  <!-- LEFT: RANKS LEGEND -->
  <div class="column legend-box" style="width:200px;">
    <h2>Ranks Legend</h2>
    <div style="color:#FF2900;" data-rank="Leader">Leader</div>
    <div style="color:#FF00E1;" data-rank="Council">Council</div>
    <div style="color:#00FF91;" data-rank="Captain">Captain</div>
    <div style="color:#FFF12E;" data-rank="Legend">Legend</div>
    <div style="color:#ADA653;" data-rank="Elder">Elder</div>
    <div style="color:#A30090;" data-rank="Old School">Old School</div>
    <div style="color:#0E00A3;" data-rank="Senior">Senior</div>
    <div style="color:#003CFF;" data-rank="Member">Member</div>
    <div style="color:#00BFFF;" data-rank="Trial">Trial</div>
    <div style="color:#B6B6B6;" data-rank="Retired">Retired</div>
  </div>

  <!-- MIDDLE: MAIN TABLE -->
  <div class="column" style="flex:1;">
    <table class="stats-table" id="statsTable">
      <thead>
        <tr>
          <th>
            Player 
            <span class="sort-icons" data-skill="name"><span>‚ñ≤</span><span>‚ñº</span></span>
          </th>
          <th>
            Nickname 
            <span class="sort-icons" data-skill="nickname"><span>‚ñ≤</span><span>‚ñº</span></span>
          </th>
          <th>‚öîÔ∏è Attack <span class="sort-icons" data-skill="attack"><span>‚ñ≤</span><span>‚ñº</span></span></th>
          <th>üí™ Strength <span class="sort-icons" data-sskill="strength"><span>‚ñ≤</span><span>‚ñº</span></span></th>
          <th>üõ°Ô∏è Defence <span class="sort-icons" data-skill="defence"><span>‚ñ≤</span><span>‚ñº</span></span></th>
          <th>üèπ Ranged <span class="sort-icons" data-skill="ranged"><span>‚ñ≤</span><span>‚ñº</span></span></th>
          <th>‚ú® Magic <span class="sort-icons" data-skill="magic"><span>‚ñ≤</span><span>‚ñº</span></span></th>
          <th>üôè Prayer <span class="sort-icons" data-skill="prayer"><span>‚ñ≤</span><span>‚ñº</span></span></th>
          <th>‚ù§Ô∏è Hitpoints <span class="sort-icons" data-skill="hitpoints"><span>‚ñ≤</span><span>‚ñº</span></span></th>
          <th>‚öîÔ∏è Combat <span class="sort-icons" data-skill="combat"><span>‚ñ≤</span><span>‚ñº</span></span></th>
          <th>Total Level <span class="sort-icons" data-skill="total"><span>‚ñ≤</span><span>‚ñº</span></span></th>
        </tr>
      </thead>
      <tbody id="statsTableBody">
        <tr><td colspan="11" class="loading">Loading‚Ä¶</td></tr>
      </tbody>
    </table>
  </div>

  <!-- RIGHT: AVERAGE STATS -->
  <div class="column" style="width:250px;">
    <h2>Average Stats</h2>
    <div id="averageContent">Loading...</div>
  </div>
</div>

<div class="tooltip" id="tooltip"></div>

<script>
/* ===================== CONFIG ====================== */
const PLAYERS = [
  { name: 'G3ND3RB3ND3R', nickname:'Rare', color:'#FF2900', rank:'Leader' },
  { name: 'Big Mac luvr', nickname:'Brandan', color:'#FF2900', rank:'Leader' },
  { name: '777 Hit Man', nickname:'Uube', color:'#FF00E1', rank:'Council' },
  { name: 'AEST NFS', nickname:'Kalypso', color:'#00FF91', rank:'Captain' },
  { name: 'Big Shame', nickname:'Joog', color:'#FFF12E', rank:'Legend' },
  { name: 'Purewax', nickname:'Wax', color:'#ADA653', rank:'Elder' },
  { name: 'JoshD', nickname:'JoshD', color:'#A30090', rank:'Old School' },
  { name: 'Cutyourgrass', nickname:'Cutty', color:'#A30090', rank:'Old School' },
];

const SKILLS = [
  'overall','attack','defence','strength','hitpoints',
  'ranged','prayer','magic','cooking','woodcutting',
  'fletching','fishing','firemaking','crafting','smithing',
  'mining','herblore','agility','thieving','slayer',
  'farming','runecraft','hunter','construction','sailing'
];

const SKILL_ICONS = {
  attack:'‚öîÔ∏è', strength:'üí™', defence:'üõ°Ô∏è', ranged:'üèπ',
  magic:'‚ú®', prayer:'üôè', hitpoints:'‚ù§Ô∏è', combat:'‚öîÔ∏è',
  cooking:'üç≥', woodcutting:'ü™ì', fletching:'üèπ', fishing:'üé£',
  firemaking:'üî•', crafting:'üßµ', smithing:'üî®', mining:'‚õèÔ∏è',
  herblore:'üåø', agility:'üèÉ', thieving:'üóùÔ∏è', slayer:'üëπ',
  farming:'üåæ', runecraft:'üìú', hunter:'üèπ', construction:'üè†',
  sailing:'‚õµ'
};

let playerStats = {};
let currentSort = { skill:'total', order:'desc' };
let activeRankFilter = null;

/* ===================== API FETCH (WITH RETRY) ====================== */
async function fetchPlayer(playerName){
  const url = 'https://secure.runescape.com/m=hiscore_oldschool/index_lite.ws?player=' + playerName;

  for (let attempt=1; attempt<=5; attempt++) {
    try {
      const res = await fetch("https://api.allorigins.win/raw?url=" + encodeURIComponent(url));
      if (!res.ok) throw new Error();

      const txt = await res.text();
      const lines = txt.trim().split("\n");

      const stats = {};
      for (let i=0;i<lines.length && i<SKILLS.length;i++){
        const parts = lines[i].split(",");
        stats[SKILLS[i]] = {
          rank: parseInt(parts[0],10),
          level: parseInt(parts[1],10),
          xp: parseInt(parts[2],10)
        };
      }

      stats.combat = calculateCombat(stats);
      playerStats[playerName] = stats;
      return;
    }
    catch(e){
      console.warn(`${playerName} fetch failed, retrying ${attempt}/5`);
      await new Promise(r=>setTimeout(r, attempt*300));
    }
  }

  playerStats[playerName] = { error:true };
}

/* ===================== SEQUENTIAL LOADING ====================== */
async function loadAllPlayers(){
  document.getElementById("statsTableBody").innerHTML =
    `<tr><td colspan="11" class="loading">Loading...</td></tr>`;

  for (const p of PLAYERS){
    await fetchPlayer(p.name);
  }

  renderTable();
  renderAverageBox();
  updateTimestamp();
}

/* ===================== TIMESTAMP ====================== */
function updateTimestamp(){
  const t = new Date().toLocaleString("en-GB",{hour12:false});
  document.getElementById("lastUpdated").innerText =
    `Last updated: ${t} UTC`;
}

/* ===================== COMBAT CALC ====================== */
function calculateCombat(stats){
  const a=stats.attack?.level||1;
  const s=stats.strength?.level||1;
  const d=stats.defence?.level||1;
  const hp=stats.hitpoints?.level||10;
  const p=stats.prayer?.level||1;
  const r=stats.ranged?.level||1;
  const m=stats.magic?.level||1;

  const base = 0.25*(d+hp+Math.floor(p/2));
  const melee = 0.325*(a+s);
  const range = 0.325*(Math.floor(r/2)+r);
  const mage  = 0.325*(Math.floor(m/2)+m);

  return Math.floor(base + Math.max(melee,range,mage));
}

/* ===================== SORTING ====================== */
function sortPlayers(players, key, order){
  return players.slice().sort((A,B)=>{
    const a = playerStats[A.name];
    const b = playerStats[B.name];

    if (!a || a.error) return 1;
    if (!b || b.error) return -1;

    if (key === "name") {
      return order === "asc"
        ? A.name.localeCompare(B.name)
        : B.name.localeCompare(A.name);
    }

    if (key === "nickname") {
      return order === "asc"
        ? A.nickname.localeCompare(B.nickname)
        : B.nickname.localeCompare(A.nickname);
    }

    let va, vb;
    if (key === "total"){
      va=a.overall?.level||0;
      vb=b.overall?.level||0;
    }
    else if (key === "combat"){
      va=a.combat;
      vb=b.combat;
    }
    else {
      va=a[key]?.level||0;
      vb=b[key]?.level||0;
    }

    return order==="asc" ? va-vb : vb-va;
  });
}

/* ===================== RANK FILTER ====================== */
function filterPlayersByRank(players){
  if (!activeRankFilter) return players;
  return players.filter(p=>p.rank === activeRankFilter);
}

function clearRankFilter(){
  activeRankFilter = null;
  document.getElementById("clearFilterBtn").style.display = "none";
  renderTable();
}

/* ===================== TABLE RENDER ====================== */
function renderTable(){
  const tbody = document.getElementById("statsTableBody");

  let players = PLAYERS;
  players = filterPlayersByRank(players);
  players = sortPlayers(players, currentSort.skill, currentSort.order);

  let html = "";

  for (const p of players){
    const s = playerStats[p.name];

    if (!s){
      html += `<tr><td colspan="11" class="loading">Loading ${p.name}‚Ä¶</td></tr>`;
      continue;
    }
    if (s.error){
      html += `<tr>
        <td class="player-name" style="color:${p.color}">${p.name}</td>
        <td class="nickname" style="color:${p.color}">${p.nickname}</td>
        <td colspan="9" class="error">Name not found</td>
      </tr>`;
      continue;
    }

    const cells = [
      s.attack.level, s.strength.level, s.defence.level,
      s.ranged.level, s.magic.level, s.prayer.level,
      s.hitpoints.level, s.combat, s.overall.level
    ];

    html += `
    <tr>
      <td class="player-name" style="color:${p.color}">${p.name}</td>
      <td class="nickname" style="color:${p.color}">${p.nickname}</td>
      ${cells.map(c=>`<td>${c}</td>`).join("")}
    </tr>`;
  }

  tbody.innerHTML = html;
  attachTooltip();
}

/* ===================== TOOLTIP ====================== */
const tooltip = document.getElementById("tooltip");

function showTooltip(e, name, stats, nickname){
  let html = `<strong>${name} (${nickname})</strong><br><br>`;

  if (stats.error){
    html += "Name not found";
  } else {
    for (const skill of SKILLS){
      if (!stats[skill] || skill === "overall") continue;
      html += `${SKILL_ICONS[skill]||""} ${skill}: ${stats[skill].level}<br>`;
    }
    html += `<br><strong>Combat:</strong> ${stats.combat}<br>`;
    html += `<strong>Total Level:</strong> ${stats.overall.level}`;
  }

  tooltip.innerHTML = html;
  tooltip.style.display = "block";
  tooltip.style.left = (e.clientX + 10) + "px";
  tooltip.style.top = (e.clientY + 10) + "px";
}

function attachTooltip(){
  document.querySelectorAll(".player-name").forEach(td=>{
    td.addEventListener("mouseenter", e=>{
      const name = td.innerText;
      const p = PLAYERS.find(x=>x.name===name);
      showTooltip(e, name, playerStats[name], p.nickname);
    });
    td.addEventListener("mousemove", e=>{
      tooltip.style.left = (e.clientX+10)+"px";
      tooltip.style.top  = (e.clientY+10)+"px";
    });
    td.addEventListener("mouseleave", ()=>tooltip.style.display="none");
  });
}

/* ===================== SORT CLICK EVENTS ====================== */
document.querySelectorAll(".sort-icons").forEach(icon=>{
  const skill = icon.dataset.skill;
  const arrows = icon.querySelectorAll("span");

  arrows[0].onclick = ()=>{
    currentSort = { skill, order:"asc" };
    renderTable();
  };
  arrows[1].onclick = ()=>{
    currentSort = { skill, order:"desc" };
    renderTable();
  };
});

/* ===================== RANK FILTER CLICK EVENTS ====================== */
document.querySelectorAll(".legend-box div").forEach(div=>{
  div.onclick = ()=>{
    const rank = div.dataset.rank;

    if (activeRankFilter === rank){
      activeRankFilter = null;
      document.getElementById("clearFilterBtn").style.display="none";
    } else {
      activeRankFilter = rank;
      document.getElementById("clearFilterBtn").style.display="block";
    }

    renderTable();
  };
});

/* ===================== AVERAGE BOX ====================== */
function renderAverageBox(){
  const container = document.getElementById("averageContent");

  let count = 0;
  let totalCombat = 0;
  let totalTotal = 0;

  for (const p of PLAYERS){
    const s = playerStats[p.name];
    if (!s || s.error) continue;

    count++;
    totalCombat += s.combat;
    totalTotal  += s.overall.level;
  }

  container.innerHTML = `
    <strong>Number of players:</strong> ${count}<br>
    <strong>Average Combat:</strong> ${count?Math.round(totalCombat/count):0}<br>
    <strong>Average Total Level:</strong> ${count?Math.round(totalTotal/count):0}<br>
  `;
}

window.addEventListener("load", loadAllPlayers);
</script>

</body>
</html>
