<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Chivalry Legion High Scores</title>
<style>
body { font-family: Arial,sans-serif; background:#000; color:#fff; margin:0; padding:20px; }
.tabs { display:flex; justify-content:center; gap:5px; margin-bottom:15px; }
.tab-btn { padding:8px 15px; background:#111; border:none; color:#fff; cursor:pointer; border-radius:5px; }
.tab-btn.active { background:orange; color:#000; font-weight:bold; }
.container { display:flex; gap:15px; max-width:1600px; margin:0 auto; }
.column { background:#111; border-radius:8px; padding:15px; border:1px solid #444; overflow-x:auto; }
.column h2 { text-align:center; color:orange; margin-bottom:10px; }
.stats-table { width:100%; border-collapse:collapse; }
.stats-table th, .stats-table td { border:1px solid #444; padding:8px; text-align:center; }
.stats-table th { background:#222; font-weight:bold; color:#fff; cursor:pointer; }
.stats-table td { background:#111; color:#eee; }
.stats-table tr:nth-child(even) td { background:#1a1a1a; }
.stats-table tbody tr:hover { background:#333 !important; }
.player-name { font-weight:bold; cursor:pointer; }
.tooltip { display:none; position:fixed; background:#222; padding:10px; border-radius:6px; box-shadow:0 0 10px rgba(255,255,255,0.3); z-index:999; min-width:220px; max-height:400px; overflow-y:auto; color:#fff; font-size:12px; white-space:nowrap; }
.legend-box { width:180px; }
.legend-box div { font-weight:bold; margin:5px 0; }
.loading { text-align:center; font-style:italic; color:#999; }
.error { color:#ff4d4d; font-weight:bold; }
.refresh-btn { display:block; margin:10px auto 20px auto; padding:5px 10px; background:orange; color:#000; font-weight:bold; border:none; border-radius:5px; cursor:pointer; }
#lastUpdated { text-align:center; font-size:12px; color:#aaa; margin-top:10px; }
.skill-list-item { margin:4px 0; border-bottom:1px solid #444; padding-bottom:4px; }
</style>
</head>
<body>

<img src="https://i.imgur.com/OU2IAhu.png" alt="Clan Logo" style="display:block;margin:0 auto 10px auto; max-width:150px;">

<div class="tabs">
  <button class="tab-btn active" data-tab="mains">Mains</button>
  <button class="tab-btn" data-tab="meds">Meds</button>
  <button class="tab-btn" data-tab="ironman">Ironman</button>
  <button class="tab-btn" data-tab="hcim">HCIM</button>
  <button class="tab-btn" data-tab="uim">UIM</button>
</div>

<div class="container">
  <!-- Left column: Ranks Legend -->
  <div class="column legend-box" id="ranksLegend">
    <h2>Ranks Legend</h2>
    <div style="color:#FF2900;">Leader</div>
    <div style="color:#FF00E1;">Council</div>
    <div style="color:#00FF91;">Captain</div>
    <div style="color:#FFF12E;">Legend</div>
    <div style="color:#ADA653;">Elder</div>
    <div style="color:#A30090;">Old School</div>
    <div style="color:#0E00A3;">Senior</div>
    <div style="color:#003CFF;">Member</div>
    <div style="color:#00BFFF;">Trial</div>
    <div style="color:#B6B6B6;">Retired</div>
    <button class="refresh-btn" id="unfilterRankBtn">Unfilter</button>
  </div>

  <!-- Middle column: Player table -->
  <div class="column" style="flex:1;">
    <table class="stats-table" id="statsTable">
      <thead>
        <tr>
          <th data-sort="name">Name</th>
          <th data-sort="nickname">Nickname</th>
          <th data-sort="attack">Attack</th>
          <th data-sort="strength">Strength</th>
          <th data-sort="defence">Defence</th>
          <th data-sort="ranged">Ranged</th>
          <th data-sort="magic">Magic</th>
          <th data-sort="prayer">Prayer</th>
          <th data-sort="combat">Combat</th>
          <th data-sort="total">Total</th>
        </tr>
      </thead>
      <tbody id="statsTableBody"><tr><td colspan="10" class="loading">Loading...</td></tr></tbody>
    </table>
  </div>

  <!-- Right column: Average stats & Skill Filter Display -->
  <div class="column" style="width:250px;">
    <h2>Average Stats</h2>
    <div id="averageContent">Loading...</div>
    <div id="skillFilterList"></div>
    <button class="refresh-btn" id="unfilterSkillBtn">Unfilter</button>
  </div>
</div>

<div id="lastUpdated"></div>
<div class="tooltip" id="tooltip"></div>

<script>
/* --- CONFIG --------------------------------------------------------- */

const TABS = {
  mains: [
    { name: 'G3ND3RB3ND3R', nickname:'Rare', color:'#FF2900' },
    { name: 'Big Mac luvr', nickname:'Braeden', color:'#FF2900' },
    { name: '777 Hit Man', nickname:'Uube', color:'#FF00E1' },
    { name: 'AEST NFS', nickname:'Kaylpso', color:'#00FF91' },
    { name: 'Kranky Kraut', nickname:'Hayden', color:'#00FF91' },
    { name: 'Cutyourgrass', nickname:'Cutty', color:'#A30090' },
    { name: 'JoshD', nickname:'JoshD', color:'#A30090' },
  ],
  meds: [
    { name: 'YRUG', nickname:'Rare', color:'#FF2900' },
    { name: 'MedPlayer2', nickname:'MP2', color:'#00BFFF' },
  ],
  ironman: [
    { name: 'Iron Hayden', nickname:'Hayden', color:'#00FF91' },
    { name: 'IronLady', nickname:'ILady', color:'#FFF12E' },
  ],
  hcim: [
    { name: 'HCWarrior', nickname:'HCW', color:'#ADA653' },
  ],
  uim: [
    { name: 'UltimateU', nickname:'UU', color:'#A30090' },
  ]
};

const SKILLS = [
  'overall','attack','strength','defence','hitpoints','ranged','prayer','magic',
  'cooking','woodcutting','fletching','fishing','firemaking','crafting','smithing',
  'mining','herblore','agility','thieving','slayer','farming','runecraft','hunter',
  'construction','sailing'
];

const SKILL_ICONS = {
  attack:'âš”ï¸', strength:'ğŸ’ª', defence:'ğŸ›¡ï¸', ranged:'ğŸ¹', magic:'âœ¨', prayer:'ğŸ™',
  hitpoints:'â¤ï¸', combat:'âš”ï¸', cooking:'ğŸ³', woodcutting:'ğŸª“', fletching:'ğŸ¹',
  fishing:'ğŸ£', firemaking:'ğŸ”¥', crafting:'ğŸ§µ', smithing:'ğŸ”¨', mining:'â›ï¸',
  herblore:'ğŸŒ¿', agility:'ğŸƒ', thieving:'ğŸ—ï¸', slayer:'ğŸ‘¹', farming:'ğŸŒ¾',
  runecraft:'ğŸ“œ', hunter:'ğŸ¹', construction:'ğŸ ', sailing:'â›µ'
};

let currentTab = 'mains';
let playerStats = {};
let currentSort = {skill:'total', order:'desc'};
let rankFilter = null;
let skillFilter = null;

/* --- FETCHING ------------------------------------------------------ */

function calculateCombat(stats){
  const a=stats.attack?.level||1, s=stats.strength?.level||1, d=stats.defence?.level||1;
  const hp=stats.hitpoints?.level||10, p=stats.prayer?.level||1, r=stats.ranged?.level||1, m=stats.magic?.level||1;
  return Math.floor(0.25*(d+hp+Math.floor(p/2)) + 0.325*Math.max(a+s, Math.floor(r/2)+r, Math.floor(m/2)+m));
}

async function fetchPlayer(playerName){
  const url='https://api.allorigins.win/raw?url='+
    encodeURIComponent('https://secure.runescape.com/m=hiscore_oldschool/index_lite.ws?player='+playerName);

  while(true){
    try{
      const res=await fetch(url);
      if(!res.ok) throw new Error();
      const txt=await res.text();
      const lines=txt.trim().split('\n');
      const stats={};
      for(let i=0;i<lines.length && i<SKILLS.length;i++){
        const p=lines[i].split(',');
        stats[SKILLS[i]]={rank:+p[0],level:+p[1],xp:+p[2]};
      }
      stats.combat=calculateCombat(stats);
      stats.overall={level:stats.overall.level || 0};
      playerStats[playerName]=stats;
      return;
    }catch(err){
      await new Promise(r=>setTimeout(r,700));
    }
  }
}

/* --- MAIN LOAD ------------------------------------------------------ */

async function loadTab(tab){
  currentTab=tab;
  playerStats={};
  skillFilter=null;

  document.getElementById('statsTableBody').innerHTML=
    `<tr><td colspan="10" class="loading">Loading...</td></tr>`;

  document.getElementById('averageContent').innerHTML='Loading...';
  document.getElementById('skillFilterList').innerHTML='';

  await Promise.all(TABS[tab].map(p=>fetchPlayer(p.name)));

  renderTable();
  renderAverageBox();

  document.getElementById('lastUpdated').textContent=
    'Last updated: '+new Date().toLocaleString();
}

/* --- SORTING -------------------------------------------------------- */

function sortPlayers(arr,key,order){
  return arr.slice().sort((a,b)=>{
    const sa=playerStats[a.name], sb=playerStats[b.name];
    const va=(key==='total'?sa.overall.level:key==='combat'?sa.combat:sa[key]?.level)||0;
    const vb=(key==='total'?sb.overall.level:key==='combat'?sb.combat:sb[key]?.level)||0;
    return order==='asc'? va-vb : vb-va;
  });
}

/* --- TABLE RENDER --------------------------------------------------- */

function renderTable(){
  const tbody=document.getElementById('statsTableBody');
  let players=TABS[currentTab];

  if(rankFilter) players=players.filter(p=>p.color===rankFilter);

  // Skill filter â†’ hide table entirely
  if(skillFilter){
    tbody.innerHTML =
      `<tr><td colspan="10" class="loading">Skill filter active â€” see right panel.</td></tr>`;
    renderSkillFilterList();
    return;
  }

  players=sortPlayers(players,currentSort.skill,currentSort.order);
  
  let html='';
  for(const p of players){
    const s=playerStats[p.name];
    html+=`
      <tr>
        <td style="color:${p.color}">${p.name}</td>
        <td>${p.nickname}</td>
        <td>${s.attack.level}</td>
        <td>${s.strength.level}</td>
        <td>${s.defence.level}</td>
        <td>${s.ranged.level}</td>
        <td>${s.magic.level}</td>
        <td>${s.prayer.level}</td>
        <td>${s.combat}</td>
        <td>${s.overall.level}</td>
      </tr>`;
  }
  tbody.innerHTML=html;
}

/* --- AVERAGES ------------------------------------------------------- */

function renderAverageBox(){
  const box=document.getElementById('averageContent');
  if(skillFilter){ box.innerHTML=''; return; }

  const players=TABS[currentTab];
  const total={};
  SKILLS.forEach(s=>total[s]=0);
  let count=0;

  for(const p of players){
    const s=playerStats[p.name];
    count++;
    SKILLS.forEach(sk=>total[sk]+=s[sk]?.level||0);
    total.combat=(total.combat||0)+s.combat;
    total.total=(total.total||0)+s.overall.level;
  }

  let html='';
  SKILLS.forEach(sk=>{
    const avg=Math.round(total[sk]/count);
    html+=`<div style="cursor:pointer;" onclick="skillFilter='${sk}';renderTable();">
      ${SKILL_ICONS[sk]||''} ${sk}: ${avg}
    </div>`;
  });

  html+=`<div>Average Combat: ${Math.round(total.combat/count)}</div>`;
  html+=`<div>Average Total: ${Math.round(total.total/count)}</div>`;

  box.innerHTML=html;
}

/* --- SKILL FILTER LIST (RIGHT COLUMN) ------------------------------ */

function renderSkillFilterList(){
  const list=document.getElementById('skillFilterList');
  if(!skillFilter){ list.innerHTML=''; return; }

  const players=TABS[currentTab]
    .map(p=>({
      ...p,
      stat:playerStats[p.name][skillFilter]
    }))
    .sort((a,b)=>b.stat.xp - a.stat.xp);

  let html =
    `<h3 style="color:orange; text-align:center;">
      ${SKILL_ICONS[skillFilter]||''} ${skillFilter.toUpperCase()}
    </h3>`;

  players.forEach(p=>{
    html+=`
      <div class="skill-list-item">
        <strong style="color:${p.color}">${p.name}</strong>
        (${p.nickname})<br>
        Level: ${p.stat.level}<br>
        XP: ${p.stat.xp.toLocaleString()}
      </div>`;
  });

  list.innerHTML=html;
}

/* --- EVENTS --------------------------------------------------------- */

document.querySelectorAll('.tab-btn').forEach(btn=>{
  btn.addEventListener('click',()=>{
    document.querySelectorAll('.tab-btn')
      .forEach(b=>b.classList.remove('active'));
    btn.classList.add('active');
    loadTab(btn.dataset.tab);
  });
});

document.querySelectorAll('th').forEach(th=>{
  th.addEventListener('click',()=>{
    const key=th.dataset.sort;
    if(currentSort.skill===key)
      currentSort.order=currentSort.order==='asc'?'desc':'asc';
    else {
      currentSort.skill=key;
      currentSort.order='desc';
    }
    renderTable();
  });
});

document.getElementById('unfilterSkillBtn').addEventListener('click',()=>{
  skillFilter=null;
  document.getElementById('skillFilterList').innerHTML='';
  renderTable();
  renderAverageBox();
});

window.addEventListener('load',()=>loadTab('mains'));
</script>

</body>
</html>
