<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Chivalry Legion High Scores</title>

<style>
body {
  font-family: Arial, sans-serif;
  background: #000;
  color: #fff;
  margin:0;
  padding:20px;
}
h1 {
  text-align:center;
  color: orange;
  margin-bottom: 20px;
}
.container {
  display: flex;
  gap: 20px;
  max-width: 1600px;
  margin: 0 auto;
}
.column {
  background: #111;
  border-radius: 8px;
  padding: 15px;
  border: 1px solid #444;
  overflow-x:auto;
}
.column h2 {
  text-align:center;
  color: orange;
  margin-bottom: 10px;
}
.stats-table {
  width: 100%;
  border-collapse: collapse;
}
.stats-table th, .stats-table td {
  border: 1px solid #444;
  padding: 8px;
  text-align: center;
  font-weight: bold;
}
.stats-table th {
  background: #222;
  color: #fff;
}
.stats-table td {
  background: #111;
  color: #eee;
}
.stats-table tr:nth-child(even) td {
  background: #1a1a1a;
}
.stats-table tbody tr:hover {
  background: #333 !important;
}
.player-name {
  font-weight: bold;
  cursor:pointer;
}
.tooltip {
  display: none;
  position: fixed;
  background: #222;
  padding: 10px;
  border-radius: 6px;
  box-shadow: 0 0 10px rgba(255,255,255,0.3);
  z-index: 999;
  min-width: 220px;
  max-height: 400px;
  overflow-y: auto;
  color: #fff;
  font-size: 12px;
  white-space: nowrap;
}
.sort-icons {
  display: inline-block;
  margin-left: 5px;
  cursor: pointer;
  font-size: 12px;
  vertical-align: middle;
}
.sort-icons span {
  display: block;
  line-height: 10px;
}
.legend-box div {
  font-weight: bold;
  margin: 5px 0;
}
.loading { text-align:center; font-style:italic; color:#999; }
.error { color:#ff4d4d; font-weight:bold; }
.refresh-btn {
  display:block;
  margin: 10px auto 20px auto;
  padding: 5px 10px;
  background: orange;
  color: #000;
  font-weight: bold;
  border:none;
  border-radius:5px;
  cursor:pointer;
}
</style>
</head>
<body>

<h1>Chivalry Legion High Scores</h1>
<button class="refresh-btn" onclick="loadAllPlayers()">Refresh</button>

<div class="container">

  <!-- LEFT COLUMN â€” RANKS LEGEND -->
  <div class="column legend-box" style="width:200px;">
    <h2>Ranks Legend</h2>
    <div style="color:#FF2900;">Leader</div>
    <div style="color:#FF00E1;">Council</div>
    <div style="color:#00FF91;">Captain</div>
    <div style="color:#FFF12E;">Legend</div>
    <div style="color:#ADA653;">Elder</div>
    <div style="color:#A30090;">Old School</div>
    <div style="color:#0E00A3;">Senior</div>
    <div style="color:#003CFF;">Member</div>
    <div style="color:#00BFFF;">Trial</div>
    <div style="color:#B6B6B6;">Retired</div>
  </div>

  <!-- MIDDLE COLUMN â€” PLAYER TABLE -->
  <div class="column" style="flex:1;">
    <table class="stats-table" id="statsTable">
      <thead>
        <tr>
          <th>Player</th>
          <th>Nickname</th>
          <th>âš”ï¸ Attack</th>
          <th>ğŸ’ª Strength</th>
          <th>ğŸ›¡ï¸ Defence</th>
          <th>ğŸ¹ Ranged</th>
          <th>âœ¨ Magic</th>
          <th>ğŸ™ Prayer</th>
          <th>â¤ï¸ Hitpoints</th>
          <th>âš”ï¸ Combat</th>
          <th>Total Level</th>
        </tr>
      </thead>
      <tbody id="statsTableBody">
        <tr><td colspan="11" class="loading">Loading...</td></tr>
      </tbody>
    </table>
  </div>

  <!-- RIGHT COLUMN â€” AVERAGE STATS -->
  <div class="column" style="width:250px;">
    <h2>Average Stats</h2>
    <div id="averageContent">Loading...</div>
  </div>

</div>

<div class="tooltip" id="tooltip"></div>

<script>
/* -------------------------
   PLAYER LIST WITH NICKNAMES
----------------------------*/
const PLAYERS = [
  { name:'G3ND3RB3ND3R', nickname:'Your Nickname 1', color:'#FF2900' },
  { name:'Big Mac luvr', nickname:'Your Nickname 2', color:'#FF2900' },
  { name:'777 Hit Man', nickname:'Your Nickname 3', color:'#FF00E1' },
  { name:'AEST NFS', nickname:'Your Nickname 4', color:'#00FF91' },
  { name:'Big Shame', nickname:'Your Nickname 5', color:'#FFF12E' },
  { name:'Purewax', nickname:'Your Nickname 6', color:'#ADA653' },
  { name:'JoshD', nickname:'Your Nickname 7', color:'#A30090' },
  { name:'Cutyourgrass', nickname:'Your Nickname 8', color:'#A30090' }
];

/* SAME as your original list */
const SKILLS = [
  'overall','attack','defence','strength','hitpoints',
  'ranged','prayer','magic','cooking','woodcutting',
  'fletching','fishing','firemaking','crafting','smithing',
  'mining','herblore','agility','thieving','slayer',
  'farming','runecraft','hunter','construction','sailing'
];

let playerStats = {};

/* SKILL ICONS */
const SKILL_ICONS = {
  attack:'âš”ï¸', strength:'ğŸ’ª', defence:'ğŸ›¡ï¸', ranged:'ğŸ¹',
  magic:'âœ¨', prayer:'ğŸ™', hitpoints:'â¤ï¸', combat:'âš”ï¸',
  cooking:'ğŸ³', woodcutting:'ğŸª“', fletching:'ğŸ¹', fishing:'ğŸ£',
  firemaking:'ğŸ”¥', crafting:'ğŸ§µ', smithing:'ğŸ”¨', mining:'â›ï¸',
  herblore:'ğŸŒ¿', agility:'ğŸƒ', thieving:'ğŸ—ï¸', slayer:'ğŸ‘¹',
  farming:'ğŸŒ¾', runecraft:'ğŸ“œ', hunter:'ğŸ¹', construction:'ğŸ ',
  sailing:'â›µ'
};

/* -------------------------
   COMBAT CALCULATOR
----------------------------*/
function calculateCombat(s) {
  const a=s.attack?.level||1, st=s.strength?.level||1;
  const d=s.defence?.level||1, hp=s.hitpoints?.level||10;
  const p=s.prayer?.level||1, r=s.ranged?.level||1, m=s.magic?.level||1;
  const base = 0.25*(d+hp+Math.floor(p/2));
  const melee = 0.325*(a+st);
  const range = 0.325*(Math.floor(r/2)+r);
  const mage = 0.325*(Math.floor(m/2)+m);
  return Math.floor(base+Math.max(melee,range,mage));
}

/* -------------------------
   FETCH PLAYER STATS (WITH RETRIES)
----------------------------*/
async function fetchWithRetry(playerName) {
  const api = "https://secure.runescape.com/m=hiscore_oldschool/index_lite.ws?player=";
  const urls = [
    "https://api.allorigins.win/raw?url=" + encodeURIComponent(api + playerName),
    "https://api.codetabs.com/v1/proxy/?quest=" + encodeURIComponent(api + playerName)
  ];

  for (const url of urls) {
    for (let attempt = 1; attempt <= 3; attempt++) {
      try {
        const res = await fetch(url);
        if (!res.ok) throw new Error("Bad status");
        const txt = await res.text();
        return txt;
      } catch {
        console.warn(`Retry ${attempt} for: ${playerName}`);
      }
    }
  }
  return null;
}

async function fetchPlayer(playerName) {
  const data = await fetchWithRetry(playerName);
  if (!data) {
    playerStats[playerName] = { error: true };
    return;
  }
  const lines = data.trim().split("\n");
  const stats = {};
  for (let i=0;i<lines.length && i<SKILLS.length;i++) {
    const p = lines[i].split(",");
    stats[SKILLS[i]] = { rank:+p[0], level:+p[1], xp:+p[2] };
  }
  stats.combat = calculateCombat(stats);
  playerStats[playerName] = stats;
}

/* -------------------------
   SEQUENTIAL LOADING
----------------------------*/
async function loadAllPlayers() {
  playerStats = {};
  document.getElementById("statsTableBody").innerHTML =
    `<tr><td colspan="11" class="loading">Loading...</td></tr>`;
  document.getElementById("averageContent").innerHTML = "Loading...";

  /* LOAD ONE-BY-ONE (never fails) */
  for (const p of PLAYERS) {
    await fetchPlayer(p.name);
  }
  renderTable();
  renderAverageBox();
}

/* -------------------------
   RENDER TABLE
----------------------------*/
function renderTable() {
  const tbody = document.getElementById("statsTableBody");
  let html = "";

  for (const p of PLAYERS) {
    const s = playerStats[p.name];

    if (!s) continue;

    if (s.error) {
      html += `
        <tr>
          <td style="color:${p.color}" class="player-name">${p.name}</td>
          <td>${p.nickname}</td>
          <td colspan="9" class="error">Name not found</td>
        </tr>`;
      continue;
    }

    html += `
      <tr>
        <td class="player-name" style="color:${p.color}">${p.name}</td>
        <td>${p.nickname}</td>
        <td>${s.attack.level}</td>
        <td>${s.strength.level}</td>
        <td>${s.defence.level}</td>
        <td>${s.ranged.level}</td>
        <td>${s.magic.level}</td>
        <td>${s.prayer.level}</td>
        <td>${s.hitpoints.level}</td>
        <td>${s.combat}</td>
        <td>${s.overall.level}</td>
      </tr>`;
  }

  tbody.innerHTML = html;
  attachTooltip();
}

/* -------------------------
   TOOLTIP
----------------------------*/
const tooltip = document.getElementById("tooltip");

function attachTooltip() {
  document.querySelectorAll(".player-name").forEach(el => {
    el.addEventListener("mouseenter", e => {
      const name = e.target.textContent;
      const stats = playerStats[name];

      let html = `<strong>${name}</strong><br>`;
      if (stats.error) {
        html += "Name not found";
      } else {
        for (const skill in stats) {
          if (skill === "overall" || skill === "combat") continue;
          if (!stats[skill].level) continue;
          html += `${SKILL_ICONS[skill] || ''} ${skill}: ${stats[skill].level}<br>`;
        }
        html += `<hr>Combat: ${stats.combat}<br>Total: ${stats.overall.level}`;
      }

      tooltip.innerHTML = html;
      tooltip.style.display = "block";
      tooltip.style.left = (e.pageX + 15) + "px";
      tooltip.style.top = (e.pageY + 15) + "px";
    });

    el.addEventListener("mousemove", e => {
      tooltip.style.left = (e.pageX + 15) + "px";
      tooltip.style.top = (e.pageY + 15) + "px";
    });

    el.addEventListener("mouseleave", () => {
      tooltip.style.display = "none";
    });
  });
}

/* -------------------------
   AVERAGE STATS
----------------------------*/
function renderAverageBox() {
  const out = document.getElementById("averageContent");
  let count = 0, totalCombat = 0, totalLevel = 0;

  for (const p of PLAYERS) {
    const s = playerStats[p.name];
    if (!s || s.error) continue;
    count++;
    totalCombat += s.combat;
    totalLevel += s.overall.level;
  }

  out.innerHTML = `
    <strong>Number of players:</strong> ${PLAYERS.length}<br>
    <strong>Average Combat:</strong> ${count ? Math.round(totalCombat/count) : 0}<br>
    <strong>Average Total Level:</strong> ${count ? Math.round(totalLevel/count) : 0}
  `;
}

/* AUTOLOAD */
window.addEventListener("load", loadAllPlayers);
</script>

</body>
</html>
