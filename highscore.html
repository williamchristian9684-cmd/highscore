<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Chivalry Legion High Scores</title>
<style>
html,body{height:100%;margin:0;padding:0;background:#000;color:#fff;font-family:Arial,sans-serif;}
body{padding:20px;box-sizing:border-box;}
.tabs { display:flex; justify-content:center; gap:5px; margin-bottom:15px; }
.tab-btn { padding:8px 15px; background:#111; border:none; color:#fff; cursor:pointer; border-radius:5px; }
.tab-btn.active { background:orange; color:#000; font-weight:bold; }
.container { display:flex; gap:15px; max-width:1600px; margin:0 auto; min-height:calc(100vh - 200px); }
.column { background:#111; border-radius:8px; padding:15px; border:1px solid #444; overflow-x:auto; }
.column h2 { text-align:center; color:orange; margin-bottom:10px; }
.stats-table { width:100%; border-collapse:collapse; }
.stats-table th, .stats-table td { border:1px solid #444; padding:8px; text-align:center; }
.stats-table th { background:#222; font-weight:bold; color:#fff; cursor:pointer; }
.stats-table td { background:#111; color:#eee; }
.stats-table tr:nth-child(even) td { background:#1a1a1a; }
.stats-table tbody tr:hover { background:#333 !important; }
.player-name { font-weight:bold; cursor:pointer; }
.tooltip { display:none; position:fixed; background:#222; padding:10px; border-radius:6px; box-shadow:0 0 10px rgba(255,255,255,0.3); z-index:999; min-width:220px; max-height:400px; overflow-y:auto; color:#fff; font-size:12px; white-space:nowrap; }
.legend-box { width:180px; }
.legend-box div { font-weight:bold; margin:5px 0; cursor:pointer; }
.loading { text-align:center; font-style:italic; color:#999; }
.error { color:#ff4d4d; font-weight:bold; }
.refresh-btn { display:block; margin:10px auto 20px auto; padding:5px 10px; background:orange; color:#000; font-weight:bold; border:none; border-radius:5px; cursor:pointer; }
#lastUpdated { text-align:center; font-size:12px; color:#aaa; margin-top:10px; }
#searchBar { display:block; margin:0 auto 15px auto; padding:5px 10px; width:300px; border-radius:5px; border:none; }
</style>
</head>
<body>

<img id="clanLogo" src="https://i.imgur.com/OU2IAhu.png" alt="Clan Logo" style="display:block;margin:0 auto 10px auto; max-width:150px;cursor:pointer;">

<input type="text" id="searchBar" placeholder="Search by Name or Nickname">

<div class="tabs">
  <button class="tab-btn active" data-tab="mains">Mains</button>
  <button class="tab-btn" data-tab="meds">Meds and Pures</button>
  <button class="tab-btn" data-tab="ironman">Ironman</button>
  <button class="tab-btn" data-tab="hcim">HCIM</button>
  <button class="tab-btn" data-tab="uim">UIM</button>
</div>

<div class="container">
  <div class="column legend-box" id="ranksLegend">
    <h2>Ranks Legend</h2>
    <div style="color:#FF2900;" data-color="#FF2900">Leader</div>
    <div style="color:#FF00E1;" data-color="#FF00E1">Council</div>
    <div style="color:#00FF91;" data-color="#00FF91">Captain</div>
    <div style="color:#FFF12E;" data-color="#FFF12E">Legend</div>
    <div style="color:#ADA653;" data-color="#ADA653">Elder</div>
    <div style="color:#A30090;" data-color="#A30090">Old School</div>
    <div style="color:#0E00A3;" data-color="#0E00A3">Senior</div>
    <div style="color:#003CFF;" data-color="#003CFF">Member</div>
    <div style="color:#00BFFF;" data-color="#00BFFF">Trial</div>
    <div style="color:#B6B6B6;" data-color="#B6B6B6">Retired</div>
    <button class="refresh-btn" id="unfilterRankBtn">Unfilter</button>
  </div>

  <div class="column" style="flex:1;">
    <table class="stats-table" id="statsTable">
      <thead>
        <tr>
          <th data-sort="name">Name</th>
          <th data-sort="nickname">Nickname</th>
          <th data-sort="attack">Attack</th>
          <th data-sort="strength">Strength</th>
          <th data-sort="defence">Defence</th>
          <th data-sort="ranged">Ranged</th>
          <th data-sort="magic">Magic</th>
          <th data-sort="prayer">Prayer</th>
          <th data-sort="combat">Combat</th>
          <th data-sort="total">Total</th>
        </tr>
      </thead>
      <tbody id="statsTableBody"><tr><td colspan="10" class="loading">Loading...</td></tr></tbody>
    </table>
  </div>

  <div class="column" style="width:250px;">
    <h2>Average Stats</h2>
    <div id="averageContent">Loading...</div>
    <button class="refresh-btn" id="unfilterSkillBtn">Unfilter</button>
  </div>
</div>

<div id="lastUpdated"></div>
<div class="tooltip" id="tooltip"></div>

<script>
const TABS = {
  mains: [
    { name:'G3ND3RB3ND3R',nickname:'Rare',color:'#FF2900' },
    { name:'Big Mac luvr',nickname:'Braden',color:'#FF2900' },
    { name:'Bonds',nickname:'Gage',color:'#FF2900' },
    { name:'Kanger0o',nickname:'Karate',color:'#FF2900' },
    { name:'777 Hit Man',nickname:'Uube',color:'#FF00E1' },
    { name:'ForeskinKim',nickname:'JPS',color:'#FF00E1' },
    { name:'AEST NFS',nickname:'Kaylpso',color:'#00FF91' },
    { name:'I take off',nickname:'Buff',color:'#00FF91' },
    { name:'b udsy',nickname:'Budsy',color:'#00FF91' },
    { name:'Roo Rider',nickname:'Joog',color:'#FFF12E' },
    { name:'Purewax',nickname:'Wax',color:'#ADA653' },
    { name:'Infidel',nickname:'Infidel',color:'#ADA653' },
    { name:'Cutyourgrass',nickname:'Cutty',color:'#A30090' },
    { name:'Volunteer',nickname:'Volunteer',color:'#A30090' },
    { name:'cwazi',nickname:'Stally',color:'#A30090' },
    { name:'JoshD',nickname:'JoshD',color:'#A30090' },
    { name:'Wut Da Hally' ,nickname:'Pizza',color:'#0E00A3' },
    { name:'NZ Apho' ,nickname:'Apho',color:'#003CFF' },
    { name:'Arty Knight' ,nickname:'Dawson',color:'#003CFF' },
    { name:'CHLEFY' ,nickname:'Chief',color:'#003CFF' }, 
    { name:'K21' ,nickname:'Chief',color:'#003CFF' }, 
    { name:'Kristalnacht' ,nickname:'Midas',color:'#003CFF' }
  ],
  meds and pures:[
   { name:'YRUG',nickname:'Rare',color:'#FF2900' },
   { name:'TA-Q-BIN',nickname:'Volunteer',color:'#A30090' },
   { name:'Stiffysniffa' ,nickname:'Infidel',color:'#ADA653' },
  { name:'I screw off',nickname:'Buff',color:'#00FF91' },
   { name:'alehouse',nickname:'Stally',color:'#A30090' }
  ],
  ironman:[
    { name:'Iron Hayden',nickname:'Hayden',color:'#00FF91' },
    { name:'Big Shame' ,nickname:'Buff',color:'#00FF91' }
  ],
  hcim:[
    { name:'HCWarrior',nickname:'HCW',color:'#ADA653' }
  ],
  uim:[
    { name:'UltimateU',nickname:'UU',color:'#A30090' }
  ]
};

const SKILLS = ['overall','attack','strength','defence','hitpoints','ranged','prayer','magic','cooking','woodcutting','fletching','fishing','firemaking','crafting','smithing','mining','herblore','agility','thieving','slayer','farming','runecraft','hunter','construction','sailing'];
const SKILL_ICONS={attack:'‚öîÔ∏è',strength:'üí™',defence:'üõ°Ô∏è',ranged:'üèπ',magic:'‚ú®',prayer:'üôè',hitpoints:'‚ù§Ô∏è',combat:'‚öîÔ∏è',cooking:'üç≥',woodcutting:'ü™ì',fletching:'üèπ',fishing:'üé£',firemaking:'üî•',crafting:'üßµ',smithing:'üî®',mining:'‚õèÔ∏è',herblore:'üåø',agility:'üèÉ',thieving:'üóùÔ∏è',slayer:'üëπ',farming:'üåæ',runecraft:'üìú',hunter:'üèπ',construction:'üè†',sailing:'‚õµ'};

let currentTab='mains',playerStats={},currentSort={skill:'total',order:'desc'},rankFilter=null,skillFilter=null,searchFilter='';

function calculateCombat(stats){
  const a=stats.attack?.level||1,s=stats.strength?.level||1,d=stats.defence?.level||1,hp=stats.hitpoints?.level||10;
  const p=stats.prayer?.level||1,r=stats.ranged?.level||1,m=stats.magic?.level||1;
  return Math.floor(0.25*(d+hp+Math.floor(p/2))+0.325*Math.max(a+s,Math.floor(r/2)+r,Math.floor(m/2)+m));
}

async function fetchPlayer(playerName){
  const url='https://api.allorigins.win/raw?url=' + encodeURIComponent('https://secure.runescape.com/m=hiscore_oldschool/index_lite.ws?player='+playerName);
  while(true){
    try{
      const res=await fetch(url);
      if(!res.ok) throw new Error('HTTP '+res.status);
      const txt=await res.text();
      const lines=txt.trim().split('\n');
      const stats={};
      for(let i=0;i<lines.length && i<SKILLS.length;i++){
        const parts=lines[i].split(',');
        if(parts.length!==3) continue;
        stats[SKILLS[i]]={rank:parseInt(parts[0],10),level:parseInt(parts[1],10),xp:parseInt(parts[2],10)};
      }
      stats.combat=calculateCombat(stats);
      stats.overall={level:lines[0]?.split(',')[1]?parseInt(lines[0].split(',')[1],10):0};
      playerStats[playerName]=stats;
      return;
    }catch(e){ console.warn('Retrying fetch '+playerName); await new Promise(r=>setTimeout(r,1000)); }
  }
}

async function loadTab(tab){
  currentTab=tab;
  playerStats={};
  document.getElementById('statsTableBody').innerHTML=`<tr><td colspan="10" class="loading">Loading...</td></tr>`;
  document.getElementById('averageContent').innerHTML='Loading...';
  const players=TABS[tab];
  await Promise.all(players.map(p=>fetchPlayer(p.name)));
  renderTable();
  renderAverageBox();
  document.getElementById('lastUpdated').textContent='Last updated: '+new Date().toLocaleString();
}

function sortPlayers(arr,key,order){
  return arr.slice().sort((a,b)=>{
    const sa=playerStats[a.name],sb=playerStats[b.name];
    if(!sa||sa.error) return 1;
    if(!sb||sb.error) return -1;
    if(key==='name'||key==='nickname') return order==='asc'? a[key].localeCompare(b[key]):b[key].localeCompare(a[key]);
    const va=(key==='total'?sa.overall?.level:key==='combat'?sa.combat:sa[key]?.level)||0;
    const vb=(key==='total'?sb.overall?.level:key==='combat'?sb.combat:sb[key]?.level)||0;
    return order==='asc'? va-vb:vb-va;
  });
}

function renderTable(){
  const tbody=document.getElementById('statsTableBody');
  let players=TABS[currentTab];
  if(rankFilter) players=players.filter(p=>p.color===rankFilter);
  if(searchFilter) players=players.filter(p=>p.name.toLowerCase().includes(searchFilter)||p.nickname.toLowerCase().includes(searchFilter));
  if(skillFilter){
    players=players.map(p=>({...p, skillStat:playerStats[p.name][skillFilter]})).filter(p=>p.skillStat).sort((a,b)=>b.skillStat.xp-a.skillStat.xp);
    let html='';
    for(const p of players){
      const s=p.skillStat;
      html+=`<tr>
        <td style="color:${p.color}">${p.name}</td>
        <td>${p.nickname}</td>
        <td colspan="8">${s.level} (XP: ${s.xp})</td>
      </tr>`;
    }
    tbody.innerHTML=html;
    attachTooltip();
    return;
  }
  players=sortPlayers(players,currentSort.skill,currentSort.order);
  let html='';
  for(const p of players){
    const s=playerStats[p.name];
    if(!s){ html+=`<tr><td colspan="10" class="loading">Loading ${p.name}‚Ä¶</td></tr>`; continue; }
    if(s.error){ html+=`<tr><td style="color:${p.color}">${p.name}</td><td>${p.nickname}</td><td colspan="8" class="error">Name not found</td></tr>`; continue; }
    html+=`<tr>
      <td style="color:${p.color}">${p.name}</td>
      <td>${p.nickname}</td>
      <td>${s.attack?.level||0}</td>
      <td>${s.strength?.level||0}</td>
      <td>${s.defence?.level||0}</td>
      <td>${s.ranged?.level||0}</td>
      <td>${s.magic?.level||0}</td>
      <td>${s.prayer?.level||0}</td>
      <td>${s.combat||0}</td>
      <td>${s.overall?.level||0}</td>
    </tr>`;
  }
  tbody.innerHTML=html;
  attachTooltip();
}

function renderAverageBox(){
  const container=document.getElementById('averageContent');
  const players=TABS[currentTab];
  const total={};
  for(const skill of SKILLS.concat(['combat','total'])) total[skill]=0;
  let count=0;
  for(const p of players){
    const s=playerStats[p.name];
    if(!s||s.error) continue;
    count++;
    for(const skill of SKILLS) total[skill]+=s[skill]?.level||0;
    total.combat+=s.combat||0;
    total.total+=s.overall?.level||0;
  }
  let html='';
  for(const skill of SKILLS){
    const avg=count?Math.round(total[skill]/count):0;
    html+=`<div style="cursor:pointer;" onclick="skillFilter='${skill}';renderTable();">${SKILL_ICONS[skill]||''} ${skill.charAt(0).toUpperCase()+skill.slice(1)}: ${avg}</div>`;
  }
  html+=`<div>Average Combat: ${count?Math.round(total.combat/count):0}</div>`;
  html+=`<div>Average Total: ${count?Math.round(total.total/count):0}</div>`;
  container.innerHTML=html;
}

const tooltip=document.getElementById('tooltip');
function showTooltip(e,playerName,stats){
  let html=`<strong>${playerName}</strong><br>`;
  if(stats.error) html+='Name not found';
  else {
    for(const skill of SKILLS){
      html+=`${SKILL_ICONS[skill]||''} ${skill.charAt(0).toUpperCase()+skill.slice(1)}: ${stats[skill]?.level||0} (XP: ${stats[skill]?.xp||0})<br>`;
    }
    html+=`Combat: ${stats.combat}<br>Total: ${stats.overall?.level||0}`;
  }
  tooltip.innerHTML=html;
  tooltip.style.display='block';
  tooltip.style.top=`${e.clientY+10}px`;
  tooltip.style.left=`${e.clientX+10}px`;
}
function moveTooltip(e){ tooltip.style.top=`${e.clientY+10}px`; tooltip.style.left=`${e.clientX+10}px`; }
function hideTooltip(){ tooltip.style.display='none'; }
function attachTooltip(){
  document.querySelectorAll('#statsTable tbody tr').forEach(tr=>{
    tr.onmouseenter = e=>{
      const name=tr.children[0].textContent;
      if(playerStats[name]) showTooltip(e,name,playerStats[name]);
    };
    tr.onmousemove = moveTooltip;
    tr.onmouseleave = hideTooltip;
  });
}

// Event listeners
document.querySelectorAll('.tab-btn').forEach(btn=>{
  btn.addEventListener('click',()=>{ 
    document.querySelectorAll('.tab-btn').forEach(b=>b.classList.remove('active'));
    btn.classList.add('active'); 
    loadTab(btn.dataset.tab);
  });
});
document.querySelectorAll('th').forEach(th=>{
  th.addEventListener('click',()=>{ 
    const key=th.dataset.sort; 
    if(currentSort.skill===key) currentSort.order=currentSort.order==='asc'?'desc':'asc';
    else { currentSort.skill=key; currentSort.order='desc'; }
    renderTable();
  });
});
document.querySelectorAll('#ranksLegend div[data-color]').forEach(div=>{
  div.addEventListener('click',()=>{
    rankFilter=div.dataset.color;
    renderTable();
  });
});
document.getElementById('unfilterRankBtn').addEventListener('click',()=>{ rankFilter=null; renderTable(); });
document.getElementById('unfilterSkillBtn').addEventListener('click',()=>{ skillFilter=null; renderTable(); });
document.getElementById('searchBar').addEventListener('input',e=>{ searchFilter=e.target.value.toLowerCase(); renderTable(); });
document.getElementById('clanLogo').addEventListener('click',()=>loadTab(currentTab));

window.addEventListener('load',()=>loadTab('mains'));
</script>

</body>
</html>















